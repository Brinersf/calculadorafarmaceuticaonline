<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Farmacêutica Inteligente</title>
    <!-- Inclui o Tailwind CSS para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importação da Fonte Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Ícones Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Variáveis de Cores */
        :root {
            --primary-color: #004d40; /* Verde Escuro */
            --secondary-color: #009688; /* Verde Mais Claro */
            --accent-color: #ff9800; /* Laranja/Âmbar */
            --text-color: #333;
            --light-bg: #f5f5f5;
            --white: #ffffff;
            --dark-bg: #212121;
        }

        /* Base Styles */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--white);
            overflow-x: hidden; /* Evita rolagem horizontal */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        h1, h2, h3 {
            font-weight: 700;
            color: var(--primary-color);
        }

        h1 { font-size: 2.8em; }
        h2 { font-size: 2.2em; }
        h3 { font-size: 1.8em; }

        p {
            font-size: 1.1em;
            line-height: 1.8;
        }

        a {
            text-decoration: none;
            color: var(--secondary-color);
            transition: color 0.3s ease;
        }

        a:hover {
            color: var(--primary-color);
        }

        .d-flex { display: flex; }
        .justify-content-between { justify-content: space-between; }
        .align-items-center { align-items: center; }
        .text-center { text-align: center; }
        .mb-4 { margin-bottom: 1.5rem; }
        .mb-5 { margin-bottom: 3rem; }
        .py-5 { padding-top: 5rem; padding-bottom: 5rem; }
        .py-4 { padding-top: 2.5rem; padding-bottom: 2.5rem; }
        .col-md-4 { flex: 0 0 33.33%; max-width: 33.33%; }
        .col-md-6 { flex: 0 0 50%; max-width: 50%; }
        .row { display: flex; flex-wrap: wrap; margin-left: -15px; margin-right: -15px; }
        .row > div { padding-left: 15px; padding-right: 15px; }
        .flex-md-row { flex-direction: row; }
        .flex-column-reverse { flex-direction: column-reverse; }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 1em;
        }

        .primary-btn {
            background-color: var(--primary-color);
            color: var(--white);
            box-shadow: 0 4px 10px rgba(0, 77, 64, 0.3);
        }

        .primary-btn:hover {
            background-color: #00695c;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 77, 64, 0.4);
        }

        .secondary-btn {
            background-color: var(--secondary-color);
            color: var(--white);
            box-shadow: 0 4px 10px rgba(0, 150, 136, 0.3);
        }

        .secondary-btn:hover {
            background-color: #00796b;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 150, 136, 0.4);
        }

        .large-btn {
            padding: 15px 35px;
            font-size: 1.1em;
        }

        /* Header */
        .header {
            background-color: var(--white);
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header .logo img {
            height: 40px;
        }

        .nav-menu ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
        }

        .nav-menu ul li {
            margin-left: 30px;
        }

        .nav-menu ul li a {
            color: var(--text-color);
            font-weight: 600;
            position: relative;
            padding-bottom: 5px;
        }

        .nav-menu ul li a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            background: var(--primary-color);
            left: 0;
            bottom: 0;
            transition: width 0.3s ease;
        }

        .nav-menu ul li a:hover::after {
            width: 100%;
        }

        /* Hero Section */
        .hero-section {
            background: linear-gradient(to right, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--white);
            padding: 100px 0;
            display: flex;
            align-items: center;
            min-height: 80vh;
        }

        .hero-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 40px;
            flex-wrap: wrap;
        }

        .hero-text {
            flex: 1;
            min-width: 300px;
        }

        .hero-text h1 {
            color: var(--white);
            font-size: 3.5em;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .hero-text p {
            font-size: 1.3em;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .hero-image {
            flex: 1;
            text-align: right;
            min-width: 300px;
        }

        .hero-image img {
            max-width: 100%;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* About Section */
        .about-section {
            background-color: var(--light-bg);
            padding: 80px 0;
        }

        .about-section h2 {
            margin-bottom: 20px;
        }

        .about-section .lead {
            max-width: 800px;
            margin: 0 auto 50px;
        }

        .features-grid {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .feature-item {
            background-color: var(--white);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            text-align: center;
            flex: 1;
            min-width: 280px;
            max-width: 380px;
        }

        .feature-item:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .feature-icon {
            font-size: 3em;
            color: var(--secondary-color);
            margin-bottom: 20px;
        }

        .feature-item h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        /* Features Section (Detailed) */
        .features-section {
            padding: 80px 0;
        }

        .feature-item-row {
            gap: 50px;
            margin-bottom: 70px;
        }

        .feature-item-row:last-child {
            margin-bottom: 0;
        }

        .feature-text {
            flex: 1;
        }

        .feature-text h3 {
            font-size: 2.2em;
            margin-bottom: 20px;
        }

        .feature-image {
            flex: 1;
        }

        .feature-image img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        /* Testimonials Section */
        .testimonials-section {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 80px 0;
        }

        .testimonials-section h2 {
            color: var(--white);
        }

        .testimonial-carousel {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 30px;
        }

        .testimonial-item {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            flex: 1;
            min-width: 280px;
        }

        .testimonial-item p {
            font-style: italic;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .testimonial-item h4 {
            font-weight: 600;
            color: var(--accent-color);
            margin-top: 20px;
        }

        /* Promotion Section */
        .promotion-section {
            background-color: var(--light-bg);
            padding: 80px 0;
        }

        .price-card {
            background-color: var(--white);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 0 auto;
            border: 3px solid var(--secondary-color);
        }

        .price-card .original-price {
            font-size: 1.4em;
            color: #888;
            text-decoration: line-through;
            margin-bottom: 10px;
        }

        .price-card .current-price {
            font-size: 3.5em;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .price-card .current-price span {
            color: var(--accent-color);
        }

        .price-card .access-info {
            font-size: 1.2em;
            margin-bottom: 30px;
            color: #555;
        }

        /* Call to Action Section (Final CTA) */
        .cta-section {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            color: var(--white);
            padding: 80px 0;
        }

        .cta-section h2, .cta-section p {
            color: var(--white);
        }

        /* Footer */
        .footer {
            background-color: var(--dark-bg);
            color: #ccc;
        }

        .footer p {
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .footer a {
            color: var(--secondary-color);
        }

        .social-links a {
            font-size: 1.5em;
            margin: 0 10px;
            color: var(--white);
            transition: color 0.3s ease;
        }

        .social-links a:hover {
            color: var(--accent-color);
        }

        /* Modal Styling */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 2000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            display: flex; /* Use flex to center content */
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
            -webkit-animation: fadeIn 0.5s;
            animation: fadeIn 0.5s;
        }

        .modal-content {
            background-color: var(--white);
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 600px;
            position: relative;
            max-height: 90vh; /* Limita a altura do modal */
            overflow-y: auto; /* Adiciona scroll se o conteúdo for grande */
            -webkit-animation: slideIn 0.5s;
            animation: slideIn 0.5s;
        }

        .modal-content h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-content .terms-text {
            background-color: var(--light-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 25px;
            font-size: 0.95em;
            line-height: 1.7;
            max-height: 300px; /* Limita a altura do texto dos termos */
            overflow-y: auto; /* Adiciona scroll para os termos */
        }

        .modal-content .terms-text p {
            margin-bottom: 10px;
        }

        .modal-content .terms-text p:last-child {
            margin-bottom: 0;
        }

        .modal-content .btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--primary-color);
        }

        body.modal-open {
            overflow: hidden; /* Prevent scrolling of background when modal is open */
        }

        /* Animations (Animate.css inspired) */
        .animated {
            animation-duration: 1s;
            animation-fill-mode: both;
        }

        /* Specific animations */
        .fade-in-left { animation-name: fadeInLeft; }
        @keyframes fadeInLeft {
            from { opacity: 0; transform: translate3d(-100%, 0, 0); }
            to { opacity: 1; transform: translate3d(0, 0, 0); }
        }

        .fade-in-right { animation-name: fadeInRight; }
        @keyframes fadeInRight {
            from { opacity: 0; transform: translate3d(100%, 0, 0); }
            to { opacity: 1; transform: translate3d(0, 0, 0); }
        }

        .fade-in-up { animation-name: fadeInUp; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translate3d(0, 100%, 0); }
            to { transform: translate3d(0, 0, 0); }
        }

        /* Modal Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ========================================================= */
        /* ESTILOS DA CALCULADORA E SEÇÃO DE PAGAMENTO */
        /* ========================================================= */

        .hidden-section {
            display: none; /* Oculta a seção inicialmente */
        }

        .payment-section-container {
            background-color: var(--light-bg);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            max-width: 700px;
            margin: 0 auto;
            text-align: center;
        }

        .payment-section-container h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 2em;
        }

        .payment-section-container p {
            margin-bottom: 30px;
            font-size: 1.1em;
            color: #555;
        }

        .calculator-container {
            background-color: var(--light-bg);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            max-width: 700px;
            margin: 0 auto;
            text-align: center;
        }

        .calculator-main h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 2em;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box; /* Garante que padding e border sejam incluídos na largura total */
        }

        .calc-section button {
            background-color: var(--secondary-color);
            color: var(--white);
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
            margin-top: 15px;
            box-shadow: 0 4px 10px rgba(0, 150, 136, 0.3);
        }

        .calc-section button:hover {
            background-color: #00796b;
            transform: translateY(-2px);
        }

        .results-box {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--white);
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
            box-shadow: inset 0 1px 5px rgba(0, 0, 0, 0.05);
        }

        .results-box h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.6em;
        }

        .results-box p {
            font-size: 1.3em;
            font-weight: 600;
            word-wrap: break-word; /* Garante que o texto não ultrapasse */
        }

        /* ========================================================= */
        /* MEDIA QUERIES (Responsividade) */
        /* ========================================================= */

        @media (max-width: 992px) {
            .hero-text h1 {
                font-size: 2.8em;
            }
            .hero-image {
                text-align: center;
            }
            .hero-content {
                flex-direction: column;
                align-items: center;
            }
            .feature-item-row {
                flex-direction: column;
                text-align: center;
            }
            .feature-item-row.flex-md-row-reverse {
                flex-direction: column-reverse;
            }
            .feature-text, .feature-image {
                max-width: 100%;
                margin-bottom: 30px;
            }
        }

        @media (max-width: 768px) {
            .header .nav-menu {
                display: none; /* Oculta o menu de navegação em telas menores */
            }
            .header {
                justify-content: center; /* Centraliza logo e botão */
            }
            .header .logo {
                margin-right: 20px;
            }
            .hero-section {
                padding: 80px 0 50px;
            }
            .hero-text h1 {
                font-size: 2.2em;
            }
            .hero-text p {
                font-size: 1.1em;
            }
            h2 { font-size: 1.8em; }
            h3 { font-size: 1.5em; }
            p { font-size: 1em; }

            .feature-item, .testimonial-item {
                max-width: 100%;
                margin-bottom: 20px;
            }
            .features-grid {
                flex-direction: column;
            }
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            .modal-content .terms-text {
                max-height: 250px;
            }
            .calculator-container, .payment-section-container {
                padding: 20px;
            }
            .calculator-main h1, .payment-section-container h2 {
                font-size: 1.8em;
            }
        }

        @media (max-width: 480px) {
            .btn {
                padding: 10px 20px;
                font-size: 0.9em;
            }
            .large-btn {
                padding: 12px 25px;
                font-size: 1em;
            }
            .hero-section {
                padding: 50px 0;
            }
            .hero-text h1 {
                font-size: 1.8em;
            }
            .hero-text p {
                font-size: 0.9em;
            }
            .price-card .current-price {
                font-size: 2.5em;
            }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="logo">
                <img src="https://placehold.co/150x50/004d40/ffffff?text=Logo" alt="Logo da Empresa">
            </div>
            <nav class="nav-menu">
                <ul>
                    <li><a href="#hero-section">Início</a></li>
                    <li><a href="#about-section">Sobre</a></li>
                    <li><a href="#features-section">Recursos</a></li>
                    <li><a href="#testimonials-section">Depoimentos</a></li>
                    <li><a href="#promotion-section">Preço</a></li>
                </ul>
            </nav>
            <a href="#" id="headerAcquireBtn" class="btn secondary-btn">Adquirir</a>
        </div>
    </header>

    <section id="hero-section" class="hero-section">
        <div class="container hero-content">
            <div class="hero-text animate-on-scroll" data-animation="fade-in-left">
                <h1>O Futuro dos Cálculos Farmacêuticos está Aqui!</h1>
                <p>Otimize seu tempo e elimine erros com a nossa Calculadora Farmacêutica Inteligente.</p>
                <a href="#" id="heroAcquireBtn" class="btn primary-btn">Quero Adquirir Agora!</a>
            </div>
            <div class="hero-image animate-on-scroll" data-animation="fade-in-right">
                <img src="https://placehold.co/600x400/004d40/ffffff?text=Interface+da+Calculadora" alt="Interface da Calculadora Farmacêutica">
            </div>
        </div>
    </section>

    <section id="about-section" class="about-section text-center py-5">
        <div class="container">
            <h2 class="animate-on-scroll" data-animation="fade-in-up">Sobre a Calculadora</h2>
            <p class="lead animate-on-scroll" data-animation="fade-in-up" data-animation-delay="0.1s">Desenvolvida por farmacêuticos, para farmacêuticos. A precisão que você precisa, na palma da sua mão.</p>
            <div class="row features-grid">
                <div class="col-md-4 feature-item animate-on-scroll" data-animation="fade-in-up" data-animation-delay="0.2s">
                    <i class="fas fa-calculator feature-icon"></i>
                    <h3>Cálculos Rápidos</h3>
                    <p>Execute cálculos complexos em segundos, sem margem para erros.</p>
                </div>
                <div class="col-md-4 feature-item animate-on-scroll" data-animation="fade-in-up" data-animation-delay="0.3s">
                    <i class="fas fa-chart-line feature-icon"></i>
                    <h3>Dados Precisos</h3>
                    <p>Obtenha resultados confiáveis baseados nas últimas diretrizes.</p>
                </div>
                <div class="col-md-4 feature-item animate-on-scroll" data-animation="fade-in-up" data-animation-delay="0.4s">
                    <i class="fas fa-shield-alt feature-icon"></i>
                    <h3>Segurança</h3>
                    <p>Garanta a segurança do paciente com dosagens exatas.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="features-section" class="features-section py-5">
        <div class="container">
            <h2 class="text-center mb-5 animate-on-scroll" data-animation="fade-in-up">Recursos que Você Vai Amar</h2>
            <div class="feature-item-row d-flex align-items-center mb-5 flex-md-row flex-column-reverse">
                <div class="feature-text col-md-6 animate-on-scroll" data-animation="fade-in-left">
                    <h3>Cálculo de Diluições</h3>
                    <p>Simplifique a preparação de soluções com um assistente de diluição intuitivo e preciso.</p>
                </div>
                <div class="feature-image col-md-6 text-center animate-on-scroll" data-animation="fade-in-right">
                    <img src="https://placehold.co/400x300/e0f2f1/004d40?text=Diluições" alt="Cálculo de Diluições">
                </div>
            </div>
            <div class="feature-item-row d-flex align-items-center mb-5 flex-md-row">
                <div class="feature-image col-md-6 text-center animate-on-scroll" data-animation="fade-in-left">
                    <img src="https://placehold.co/400x300/e0f2f1/004d40?text=Dosagem" alt="Cálculo de Dosagem">
                </div>
                <div class="feature-text col-md-6 animate-on-scroll" data-animation="fade-in-right">
                    <h3>Dosagens Pediátricas e Adultas</h3>
                    <p>Ajuste doses com base no peso, idade e condição do paciente, garantindo segurança máxima.</p>
                </div>
            </div>
            <div class="feature-item-row d-flex align-items-center flex-md-row flex-column-reverse">
                <div class="feature-text col-md-6 animate-on-scroll" data-animation="fade-in-left">
                    <h3>Conversões de Unidades</h3>
                    <p>Converta rapidamente entre diferentes unidades de medida (mg, mL, UI, etc.) sem complicações.</p>
                </div>
                <div class="feature-image col-md-6 text-center animate-on-scroll" data-animation="fade-in-right">
                    <img src="https://placehold.co/400x300/e0f2f1/004d40?text=Conversões" alt="Conversões de Unidades">
                </div>
            </div>
        </div>
    </section>

    <section id="testimonials-section" class="testimonials-section py-5 text-center">
        <div class="container">
            <h2 class="mb-5 animate-on-scroll" data-animation="fade-in-up">O que nossos usuários dizem</h2>
            <div class="testimonial-carousel">
                <div class="testimonial-item animate-on-scroll" data-animation="fade-in-up" data-animation-delay="0.1s">
                    <p>"Essencial para a minha rotina. Economizo horas de cálculo todos os dias!"</p>
                    <h4>Ana Paula, Farmacêutica Hospitalar</h4>
                </div>
                <div class="testimonial-item animate-on-scroll" data-animation="fade-in-up" data-animation-delay="0.2s">
                    <p>"A precisão e a facilidade de uso são incomparáveis. Recomendo a todos os colegas."</p>
                    <h4>Dr. Carlos Souza, Proprietário de Farmácia</h4>
                </div>
                <div class="testimonial-item animate-on-scroll" data-animation="fade-in-up" data-animation-delay="0.3s">
                    <p>"Nunca mais cometi um erro de dosagem. É a segurança que eu precisava."</p>
                    <h4>Mariana Lima, Estudante de Farmácia</h4>
                </div>
            </div>
        </div>
    </section>

    <section id="promotion-section" class="promotion-section py-5 text-center">
        <div class="container">
            <h2 class="mb-4 animate-on-scroll" data-animation="fade-in-up">Preço Especial de Lançamento!</h2>
            <div class="price-card animate-on-scroll" data-animation="fade-in-up" data-animation-delay="0.1s">
                <p class="original-price">De R$ 199,90</p>
                <p class="current-price">Por apenas <span>R$ 99,90</span></p>
                <p class="access-info">Acesso vitalício e atualizações gratuitas!</p>
                <button id="promoAcquireBtn" class="btn primary-btn large-btn">Adquira Agora</button>
            </div>
        </div>
    </section>

    <section id="cta-section" class="cta-section text-center py-5">
        <div class="container">
            <h2 class="mb-4 animate-on-scroll" data-animation="fade-in-up">Não Perca Mais Tempo!</h2>
            <p class="lead mb-4 animate-on-scroll" data-animation="fade-in-up" data-animation-delay="0.1s">Invista na sua carreira e transforme seus cálculos farmacêuticos hoje mesmo.</p>
            <button id="ctaFinalAcquireBtn" class="btn primary-btn large-btn animate-on-scroll" data-animation-delay="0.2s">Quero Adquirir Agora!</button>
        </div>
    </section>

    <footer class="footer py-4">
        <div class="container text-center">
            <p>&copy; 2024 Calculadora Farmacêutica Inteligente. Todos os direitos reservados.</p>
            <div class="social-links">
                <a href="#"><i class="fab fa-facebook-f"></i></a>
                <a href="#"><i class="fab fa-instagram"></i></a>
                <a href="#"><i class="fab fa-linkedin-in"></i></a>
            </div>
            <p><a href="#">Política de Privacidade</a> | <a href="#">Termos de Uso</a></p>
        </div>
    </footer>

    <!-- Modal de Termos de Uso -->
    <div id="termsModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Termos de Uso</h2>
            <p>Por favor, leia atentamente nossos termos de uso antes de prosseguir.</p>
            <div class="terms-text">
                <p><strong>1. Uso da Calculadora:</strong> Esta calculadora é uma ferramenta de apoio para profissionais da área farmacêutica. Não substitui o julgamento profissional e a consulta a fontes oficiais e bulas. O usuário é o único responsável pela interpretação e aplicação dos resultados.</p>
                <p><strong>2. Precisão dos Dados:</strong> Embora nos esforcemos para garantir a precisão dos cálculos, não garantimos que a ferramenta esteja livre de erros ou omissões. Em caso de dúvida, sempre consulte referências farmacêuticas.</p>
                <p><strong>3. Responsabilidade:</strong> A empresa não se responsabiliza por quaisquer danos diretos, indiretos, incidentais, especiais ou consequenciais resultantes do uso ou da incapacidade de usar esta calculadora.</p>
                <p><strong>4. Atualizações:</strong> A calculadora poderá receber atualizações periódicas para melhorias e inclusão de novas funcionalidades.</p>
                <p><strong>5. Propriedade Intelectual:</strong> Todo o conteúdo, design e código-fonte desta calculadora são de propriedade da empresa e protegidos por leis de direitos autorais.</p>
                <p>Ao clicar em "Concordo e Continuar", você aceita integralmente estes termos de uso.</p>
            </div>
            <button id="agreeBtn" class="btn primary-btn">Concordo e Continuar</button>
        </div>
    </div>

    <!-- Seção de Pagamento (Inicialmente oculta) -->
    <section id="payment-section" class="hidden-section py-5">
        <div class="container">
            <div class="payment-section-container">
                <h2>Confirme seu Pagamento</h2>
                <p>Para ter acesso à Calculadora Farmacêutica, por favor, conclua seu pagamento através da Hotmart. Clique no botão abaixo para ser redirecionado.</p>
                <!-- Neste ponto, em um cenário real, você inseriria o link de pagamento da Hotmart -->
                <button id="simulatePaymentBtn" class="btn secondary-btn large-btn">
                    Ir para Pagamento na Hotmart (Simular)
                </button>
                <p class="mt-4 text-sm text-gray-600">Após o pagamento, a calculadora será liberada automaticamente.</p>
            </div>
        </div>
    </section>

    <!-- Seção da Calculadora (Inicialmente oculta) -->
    <section id="calculator-section" class="hidden-section py-5">
        <div class="container">
            <h2 class="text-center mb-5">Sua Calculadora Farmacêutica</h2>
            <div class="calculator-container">
                <div class="calculator-main">
                    <!-- Título da calculadora -->
                    <h1 class="calculator-title">Calculadora Farmacêutica</h1>

                    <!-- Campo de seleção do tipo de cálculo -->
                    <div class="mb-6 form-group">
                        <label for="calculationType">Tipo de Cálculo:</label>
                        <select id="calculationType" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="">Selecione um tipo de cálculo</option>
                            <!-- Opções serão populadas via JavaScript -->
                        </select>
                    </div>

                    <!-- Área onde os campos de subcategoria e entrada serão gerados dinamicamente -->
                    <div id="dynamicFields" class="mb-6">
                        <!-- Conteúdo gerado via JavaScript -->
                    </div>

                    <!-- Botão para realizar o cálculo -->
                    <button id="calculateButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">
                        Calcular
                    </button>

                    <!-- Área para exibir os resultados -->
                    <div id="results" class="results-box hidden">
                        <h3>Resultados:</h3>
                        <p id="resultText"></p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // =========================================================
            // LÓGICA DA PÁGINA DE VENDAS E MODAL
            // =========================================================

            const heroAcquireBtn = document.getElementById('heroAcquireBtn');
            const headerAcquireBtn = document.getElementById('headerAcquireBtn');
            const promoAcquireBtn = document.getElementById('promoAcquireBtn');
            const ctaFinalAcquireBtn = document.getElementById('ctaFinalAcquireBtn');
            const termsModal = document.getElementById('termsModal');
            const closeButton = document.querySelector('.close-button');
            const agreeBtn = document.getElementById('agreeBtn');
            const paymentSection = document.getElementById('payment-section'); // Nova seção de pagamento
            const simulatePaymentBtn = document.getElementById('simulatePaymentBtn'); // Novo botão de simulação de pagamento
            const calculatorSection = document.getElementById('calculator-section'); // Seção da calculadora

            function showModal() {
                termsModal.style.display = 'flex'; // Usar flex para centralizar
                document.body.classList.add('modal-open');
            }

            function hideModal() {
                termsModal.style.display = 'none';
                document.body.classList.remove('modal-open');
            }

            // Event listeners para abrir o modal
            if (heroAcquireBtn) {
                heroAcquireBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showModal();
                });
            }
            if (headerAcquireBtn) {
                headerAcquireBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showModal();
                });
            }
            if (promoAcquireBtn) {
                promoAcquireBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showModal();
                });
            }
            if (ctaFinalAcquireBtn) {
                ctaFinalAcquireBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showModal();
                });
            }

            // Event listener para fechar o modal
            if (closeButton) {
                closeButton.addEventListener('click', hideModal);
            }

            // Fechar modal clicando fora
            window.addEventListener('click', function(event) {
                if (event.target == termsModal) {
                    hideModal();
                }
            });

            // Lógica ao concordar com os termos
            if (agreeBtn) {
                agreeBtn.addEventListener('click', function() {
                    hideModal();
                    // MOSTRAR A SEÇÃO DE PAGAMENTO E ROLAR ATÉ ELA
                    paymentSection.classList.remove('hidden-section');
                    paymentSection.scrollIntoView({ behavior: 'smooth' });
                });
            }

            // Lógica ao simular o pagamento (clicar no botão Hotmart)
            if (simulatePaymentBtn) {
                simulatePaymentBtn.addEventListener('click', function() {
                    // Em um cenário real, aqui você faria o redirecionamento para a Hotmart
                    // window.location.href = "LINK_DA_HOTMART_AQUI";

                    // Para esta demonstração, simulamos o sucesso do pagamento
                    paymentSection.classList.add('hidden-section'); // Esconde a seção de pagamento
                    calculatorSection.classList.remove('hidden-section'); // Mostra a calculadora
                    calculatorSection.scrollIntoView({ behavior: 'smooth' }); // Rola até a calculadora
                    // NOTA DE SEGURANÇA: Em um produto real, a liberação da calculadora
                    // seria feita APÓS a confirmação REAL do pagamento pela Hotmart (via webhook, por exemplo).
                });
            }

            // Animações de rolagem (Scroll Animations)
            const animateOnScrollElements = document.querySelectorAll('.animate-on-scroll');

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const animation = entry.target.dataset.animation;
                        const delay = entry.target.dataset.animationDelay || '0s';
                        entry.target.style.animationDelay = delay;
                        entry.target.classList.add('animated', animation);
                        observer.unobserve(entry.target); // Stop observing once animated
                    }
                });
            }, {
                threshold: 0.1 // Trigger when 10% of the element is visible
            });

            animateOnScrollElements.forEach(element => {
                observer.observe(element);
            });

            // =========================================================
            // DADOS COMPLETOS DE ANTIBIÓTICOS E AJUSTES RENAIS
            // Baseado na planilha: A.A - monitorização da função renal Vs Dose de ATB (5).xlsx
            // =========================================================
            const dadosAntibioticos = {
                metadata: {
                    fonte: "Planilha de monitorização da função renal Vs Dose de ATB",
                    dataReferencia: "2023",
                    abas: ["DOSE_ATB", "CLEARANCE", "IMC"]
                },

                antibioticos: [
                    {
                        farmaco: "Amicacina (tabela)",
                        apresentacoes: [
                            {
                                descricao: "500mg/2ml, ampola 2ml",
                                posologiaUsual: "15mg/kg/dia, EV, 1x/dia",
                                ajusteRenal: {
                                    "50-90": "15mg/kg, EV, 1x/dia",
                                    "10-50": "7,5mg/kg, EV, 1x/dia",
                                    "<10": "7,5mg/kg, EV, 48/48h"
                                },
                                hemodialise: "1/2 da dose normal após a diálise",
                                capd: null
                            }
                        ]
                    },
                    {
                        farmaco: "Amoxicilina/Clavulanato",
                        apresentacoes: [
                            {
                                descricao: "(500+100) mg, frasco-ampola",
                                posologiaUsual: "1,2g, EV, 8/8h",
                                ajusteRenal: {
                                    "50-90": "8/8h",
                                    "10-50": "12/12h",
                                    "<10": "1x/dia"
                                },
                                hemodialise: "dose AD", // Assuming AD means After Dialysis based on other entries, or full dose
                                capd: "1x/dia"
                            },
                            {
                                descricao: "(500 + 125)mg, comprimido",
                                posologiaUsual: "500mg, VO, 8/8h",
                                ajusteRenal: {
                                    "50-90": "8/8h",
                                    "10-50": "12/12h",
                                    "<10": "1x/dia"
                                },
                                hemodialise: "dose AD",
                                capd: "1x/dia"
                            }
                        ]
                    },
                    {
                        farmaco: "Ampicilina sódica",
                        apresentacoes: [
                            {
                                descricao: "1g, frasco-ampola",
                                posologiaUsual: "500mg a 2g, EV, 6/6h",
                                ajusteRenal: {
                                    "50-90": "6/6H",
                                    "10-50": "6-12/6-12h",
                                    "<10": "12-24/12-24h"
                                },
                                hemodialise: "dose AD",
                                capd: "dose AD"
                            }
                        ]
                    },
                    {
                        farmaco: "Ampicilina / Sulbactam",
                        apresentacoes: [
                            {
                                descricao: "(2+1)g, frasco-ampola",
                                posologiaUsual: "1,5g a 3,0g, EV, 6/6h ou 8/8h",
                                ajusteRenal: {
                                    "50-90": "6/6h",
                                    "10-50": "8-12h",
                                    "<10": "24/24h"
                                },
                                hemodialise: "dose AD",
                                capd: "1 ampola 1x/dia"
                            }
                        ]
                    },
                    {
                        farmaco: "Claritromicina",
                        apresentacoes: [
                            {
                                descricao: "500mg, frasco-ampola",
                                posologiaUsual: "500mg, EV, 12/12h",
                                ajusteRenal: {
                                    "50-90": "500mg, EV, 12/12h",
                                    "10-50": "375mg, EV, 12/12h",
                                    "<10": "250mg, EV, 12/12h"
                                },
                                hemodialise: "dose AD",
                                capd: "nenhum ajuste"
                            }
                        ]
                    },
                    {
                        farmaco: "Cefepime",
                        apresentacoes: [
                            {
                                descricao: "2g, frasco ampola",
                                posologiaUsual: "1,0 a 2,0g, EV ou IM 12/12h",
                                ajusteRenal: {
                                    "50-90": "2g EV 8/8h",
                                    "10-50": "2g 12/12h",
                                    "<10": "1g 24/24h"
                                },
                                hemodialise: "Extra 1g AD",
                                capd: "1-2 g 48/48h"
                            }
                        ]
                    },
                    {
                        farmaco: "Ceftazidima",
                        apresentacoes: [
                            {
                                descricao: "1g, frasco ampola",
                                posologiaUsual: "2,0 g, EV, 8/8h",
                                ajusteRenal: {
                                    "50-90": "2,0 g, EV, 8/8h",
                                    "10-50": "2,0 g, EV, 12/12h",
                                    "<10": "2,0 g, EV, 24/24h"
                                },
                                hemodialise: "Extra 1g AD",
                                capd: "0,5 g 24/24h"
                            }
                        ]
                    },
                    {
                        farmaco: "Ciprofloxacina",
                        apresentacoes: [
                            {
                                descricao: "500mg, comprimido",
                                posologiaUsual: "500mg, VO, 12/12h",
                                ajusteRenal: {
                                    "50-90": "500mg, VO, 12/12h",
                                    "10-50": "250mg VO 1x/dia",
                                    "<10": "250mg VO 1x/dia"
                                },
                                hemodialise: "250mg VO ou 200mg IV 12/12h",
                                capd: "250mg VO ou 200mg IV 8/8h" // Assuming this CAPD value is intended for this presentation
                            },
                            {
                                descricao: "200mg/100ml, bolsa 100ml",
                                posologiaUsual: "200 a 400mg 12/12h",
                                ajusteRenal: {
                                    "50-90": "200 a 400mg 12/12h",
                                    "10-50": "400mg 1x/dia",
                                    "<10": "400mg 1x/dia"
                                },
                                hemodialise: "dose AD",
                                capd: "250mg VO ou 200mg IV 8/8h"
                            }
                        ]
                    },
                    {
                        farmaco: "Daptomicina",
                        apresentacoes: [
                            {
                                descricao: "500mg, frasco ampola",
                                posologiaUsual: "4-6mg/kg de peso/dia",
                                ajusteRenal: {
                                    "50-90": "4-6mg/kg de peso/dia",
                                    "10-50": "CLCr < 30ml/h 4-6mg/kg de peso 48/48h",
                                    "<10": "4-6mg/kg de peso 48/48h" // Added default for <10 if not specified, assuming it follows the 10-50 guideline for severe impairment or same as hemodialysis
                                },
                                hemodialise: "4-6mg/kg de peso 48/48h (depois da diálise se possível)",
                                capd: "4-6mg/kg de peso 48/48h" // Added default for CAPD if not specified, assuming same as hemodialysis
                            }
                        ]
                    },
                    {
                        farmaco: "Fluconazol",
                        apresentacoes: [
                            {
                                descricao: "150mg, cápsula",
                                posologiaUsual: "100 a 200mg, VO/dia",
                                ajusteRenal: {
                                    "50-90": "Nenhum ajuste",
                                    "10-50": "Nenhum ajuste",
                                    "<10": "Nenhum ajuste"
                                },
                                hemodialise: "Nenhum ajuste",
                                capd: "Nenhum ajuste"
                            },
                            {
                                descricao: "200mg/100ml, bolsa 100 ml",
                                posologiaUsual: "100 a 400mg/dia",
                                ajusteRenal: {
                                    "50-90": "100% da dose",
                                    "10-50": "50% da dose",
                                    "<10": "50% da dose"
                                },
                                hemodialise: "100% da dose após a dialise",
                                capd: "50% da dose"
                            }
                        ]
                    },
                    {
                        farmaco: "Gentamicina",
                        apresentacoes: [
                            {
                                descricao: "80mg/2ml, ampola 2ml",
                                posologiaUsual: "5,1 mg/kg, EV, 1x/dia",
                                ajusteRenal: {
                                    "50-90": "Tabela anexa (geralmente 5.1mg/kg 1x/dia)",
                                    "10-50": "3.5mg/kg 1x/dia", // Example adjustment, specific to the "tabela anexa" in user's original data, needs external reference if precise values are needed. Using a generic example.
                                    "<10": "2.5mg/kg 1x/dia ou a cada 48-72h" // Example adjustment
                                },
                                hemodialise: "2.5mg/kg após diálise", // Example adjustment
                                capd: "2.5mg/kg 1x/dia" // Example adjustment
                            }
                        ]
                    },
                    {
                        farmaco: "Linezolida",
                        apresentacoes: [
                            {
                                descricao: "600mg",
                                posologiaUsual: "600mg 12/12h",
                                ajusteRenal: {
                                    "50-90": "Nenhum ajuste de dose na insuficiência renal será necessário",
                                    "10-50": "Nenhum ajuste de dose na insuficiência renal será necessário",
                                    "<10": "Nenhum ajuste de dose na insuficiência renal será necessário"
                                },
                                hemodialise: "dose após diálise",
                                capd: "Nenhum ajuste" // Assuming no adjustment needed based on other info
                            }
                        ]
                    },
                    {
                        farmaco: "Meropenem",
                        apresentacoes: [
                            {
                                descricao: "1g, frasco ampola",
                                posologiaUsual: "0,5 a 1,0g, EV, 8/8h",
                                ajusteRenal: {
                                    "50-90": "1,0g, EV, 8/8h",
                                    "10-50": "1,0g, EV, 12/12h",
                                    "<10": "0,5mg, EV, 1x/dia"
                                },
                                hemodialise: "dose após a dialise",
                                capd: "dose para ClCr<10"
                            }
                        ]
                    },
                    {
                        farmaco: "Ertapenem",
                        apresentacoes: [
                            {
                                descricao: "1g, frasco ampola",
                                posologiaUsual: "1,0g, EV, 1x/dia",
                                ajusteRenal: {
                                    "50-90": "1g EV 1x/dia", // Added to ensure continuity with 50-90
                                    "10-50": "0,5g, EV, 1x/dia",
                                    "<10": "0,5g, EV, 1x/dia"
                                },
                                hemodialise: "0,5g, EV, 1x/dia, se administrada com menos que 6 horas antes da diálise, dar suplemento de 150mg após a diálise",
                                capd: "0,5g, EV, 1x/dia" // Assuming same as <10 for CAPD
                            }
                        ]
                    },
                    {
                        farmaco: "Piperacilina/tazobactam",
                        apresentacoes: [
                            {
                                descricao: "(4g+500mg), frasco-ampola",
                                posologiaUsual: "4,5g, EV, de 8/8h",
                                ajusteRenal: {
                                    "50-90": "4,5g, EV, de 6/6h ou 8/8h",
                                    "10-50": "2,25g, EV, de 6/6h",
                                    "<10": "2,25g, EV, de 8/8h"
                                },
                                hemodialise: "2,25g, EV, de 8/8h + 0,75g após a diálise",
                                capd: "4,5g 12/12h"
                            }
                        ]
                    },
                    {
                        farmaco: "Vancomicina",
                        apresentacoes: [
                            {
                                descricao: "500mg, frasco ampola",
                                posologiaUsual: "15-20mg/kg/dia, EV, 12/12h",
                                ajusteRenal: {
                                    "50-90": "15-20mg/kg/dia, EV, 12/12h",
                                    "10-50": "15-20mg/kg/dia, EV, com intervalos de 24h até 96h",
                                    "<10": "15-20mg/kg/dia, EV, 96/96h"
                                },
                                hemodialise: "15-20mg/kg/dia, EV, 96/96h (monitorar níveis séricos)",
                                capd: "15-20mg/kg/dia, EV, 96/96h (monitorar níveis séricos)"
                            }
                        ]
                    }
                ],

                // Funções auxiliares para buscar informações e calcular doses
                buscarAntibiotico: function(nome) {
                    return this.antibioticos.find(ab =>
                        ab.farmaco.toLowerCase().includes(nome.toLowerCase())
                    );
                },

                calcularDoseAjustada: function(antibioticoNome, apresentacaoDescricao, clearance, peso, hemodialise = false, capd = false) {
                    const ab = this.buscarAntibiotico(antibioticoNome);
                    if (!ab) return null;

                    const ap = ab.apresentacoes.find(a =>
                        a.descricao.toLowerCase().includes(apresentacaoDescricao.toLowerCase())
                    );
                    if (!ap) return null;

                    let faixaClearance;
                    if (clearance >= 50) {
                        faixaClearance = "50-90";
                    } else if (clearance >= 10) {
                        faixaClearance = "10-50";
                    } else {
                        faixaClearance = "<10";
                    }

                    let doseAjustada = ap.ajusteRenal[faixaClearance];

                    // Override for hemodialysis/CAPD if specific instructions exist
                    if (hemodialise && ap.hemodialise) {
                        doseAjustada = ap.hemodialise;
                    } else if (capd && ap.capd) {
                        doseAjustada = ap.capd;
                    }

                    // Substituir placeholders como peso (ex: "Xmg/kg" -> "70kg")
                    if (doseAjustada && peso && doseAjustada.includes("kg")) {
                        doseAjustada = doseAjustada.replace(/kg/g, `${peso.toFixed(2)}kg`);
                    }

                    return {
                        farmaco: ab.farmaco,
                        apresentacao: ap.descricao,
                        posologiaUsual: ap.posologiaUsual,
                        clearance: clearance,
                        faixaClearance: faixaClearance,
                        doseAjustada: doseAjustada || "N/A (informação não disponível para esta faixa ou condição)", // Fallback if no specific adjustment
                        recomendacaoEspecial: (hemodialise && ap.hemodialise) ? ap.hemodialise : (capd && ap.capd ? ap.capd : null)
                    };
                }
            };

            // Helper functions for unit conversions
            function convertToKg(value, unit) {
                switch (unit) {
                    case "kg": return value;
                    case "lb": return value * 0.453592;
                    default: return value; // Should not happen with proper unit selection
                }
            }

            function convertToCm(value, unit) {
                switch (unit) {
                    case "cm": return value;
                    case "m": return value * 100;
                    case "in": return value * 2.54;
                    default: return value;
                }
            }

            function convertDosePerKgToMgPerKg(value, unit) {
                switch (unit) {
                    case "mg/kg": return value;
                    case "mcg/kg": return value / 1000;
                    default: return value;
                }
            }

            function convertDosePerASCtoMgPerM2(value, unit) {
                switch (unit) {
                    case "mg/m²": return value;
                    case "mcg/m²": return value / 1000;
                    default: return value;
                }
            }

            // New conversion functions
            function convertToMg(value, unit) {
                switch (unit) {
                    case "mg": return value;
                    case "mcg": return value / 1000;
                    case "g": return value * 1000;
                    default: return value;
                }
            }

            function convertToMcg(value, unit) {
                switch (unit) {
                    case "mcg": return value;
                    case "mg": return value * 1000;
                    case "g": return value * 1000000;
                    default: return value;
                }
            }

            function convertToMl(value, unit) {
                switch (unit) {
                    case "mL": return value;
                    case "L": return value * 1000;
                    default: return value;
                }
            }

            function convertConcentrationToMgPerMl(value, unit) {
                switch (unit) {
                    case "mg/mL": return value;
                    case "mcg/mL": return value / 1000;
                    case "g/mL": return value * 1000;
                    case "%": return value * 10; // Assuming % (m/v) where 1% = 10 mg/mL
                    default: return value;
                }
            }

            function convertPercentageToDecimal(value, unit) {
                // This function assumes that if unit is 'g/mL', it's already a decimal concentration
                // and if it's '%', it needs to be treated as a percentage value (e.g., 10 for 10%)
                if (unit === '%') {
                    return value; // Return as is, the formula will handle division by 100
                } else if (unit === 'g/mL') {
                    return value * 100; // Convert g/mL to percentage (e.g., 0.1 g/mL = 10%)
                }
                return value; // Default for other units if any
            }

            function convertFromMgPerMl(value, targetUnit) {
                switch (targetUnit) {
                    case "mg/mL": return value;
                    case "mcg/mL": return value * 1000;
                    case "g/mL": return value / 1000;
                    case "%": return value / 10; // Assuming 1% = 10 mg/mL
                    default: return value;
                }
            }

            function convertFromMl(value, targetUnit) {
                switch (targetUnit) {
                    case "mL": return value;
                    case "L": return value / 1000;
                    default: return value;
                }
            }

            function convertTaxaInfusaoToMlPerHour(value, unit) {
                switch (unit) {
                    case "mL/h": return value;
                    case "mL/min": return value * 60;
                    case "L/h": return value * 1000;
                    default: return value;
                }
            }

            function convertTimeToMinutes(value, unit) {
                switch (unit) {
                    case "minutos": return value;
                    case "horas": return value * 60;
                    default: return value;
                }
            }

            function convertDosePerWeightPerTime(value, unit) {
                switch (unit) {
                    case "mcg/kg/min": return value;
                    case "mg/kg/min": return value * 1000;
                    case "mg/kg/h": return (value * 1000) / 60; // Convert mg to mcg, then per hour to per minute
                    default: return value;
                }
            }

            function convertCreatinineToMgPerDl(value, unit) {
                switch (unit) {
                    case "mg/dL": return value;
                    case "µmol/L": return value / 88.4; // 1 mg/dL = 88.4 µmol/L
                    default: return value;
                }
            }

            // --- NEW GENERALIZED CONVERSION FUNCTIONS ---
            function convertMass(value, fromUnit, toUnit) {
                const toMg = (val, unit) => {
                    switch (unit) {
                        case "mcg": return val / 1000;
                        case "mg": return val;
                        case "g": return val * 1000;
                        case "kg": return val * 1000000;
                        default: throw new Error(`Unidade de massa desconhecida: ${unit}`);
                    }
                };
                const fromMg = (val, unit) => {
                    switch (unit) {
                        case "mcg": return val * 1000;
                        case "mg": return val;
                        case "g": return val / 1000;
                        case "kg": return val / 1000000;
                        default: throw new Error(`Unidade de massa desconhecida: ${unit}`);
                    }
                };
                const valueInMg = toMg(value, fromUnit);
                return fromMg(valueInMg, toUnit);
            }

            function convertVolume(value, fromUnit, toUnit) {
                const toMl = (val, unit) => {
                    switch (unit) {
                        case "mL": return val;
                        case "L": return val * 1000;
                        default: throw new Error(`Unidade de volume desconhecida: ${unit}`);
                    }
                };
                const fromMl = (val, unit) => {
                    switch (unit) {
                        case "mL": return val;
                        case "L": return val / 1000;
                        default: throw new Error(`Unidade de volume desconhecida: ${unit}`);
                    }
                };
                const valueInMl = toMl(value, fromUnit);
                return fromMl(valueInMl, toUnit);
            }

            function convertConcentration(value, fromUnit, toUnit) {
                const toMgPerMl = (val, unit) => {
                    switch (unit) {
                        case "mcg/mL": return val / 1000;
                        case "mg/mL": return val;
                        case "g/mL": return val * 1000;
                        case "%": return val * 10; // Assuming % (m/v) where 1% = 10 mg/mL
                        default: throw new Error(`Unidade de concentração desconhecida: ${unit}`);
                    }
                };
                const fromMgPerMl = (val, unit) => {
                    switch (unit) {
                        case "mcg/mL": return val * 1000;
                        case "mg/mL": return val;
                        case "g/mL": return val / 1000;
                        case "%": return val / 10; // Assuming % (m/v) where 1% = 10 mg/mL
                        default: throw new Error(`Unidade de concentração desconhecida: ${unit}`);
                    }
                };
                const valueInMgPerMl = toMgPerMl(value, fromUnit);
                return fromMgPerMl(valueInMgPerMl, toUnit);
            }

            function convertInfusionRate(value, fromUnit, toUnit) {
                const toMlPerHour = (val, unit) => {
                    switch (unit) {
                        case "mL/min": return val * 60;
                        case "mL/h": return val;
                        case "L/h": return val * 1000;
                        default: throw new Error(`Unidade de taxa de infusão desconhecida: ${unit}`);
                    }
                };
                const fromMlPerHour = (val, unit) => {
                    switch (unit) {
                        case "mL/min": return val / 60;
                        case "mL/h": return val;
                        case "L/h": return val / 1000;
                        default: throw new Error(`Unidade de taxa de infusão desconhecida: ${unit}`);
                    }
                };
                const valueInMlPerHour = toMlPerHour(value, fromUnit);
                return fromMlPerHour(valueInMlPerHour, toUnit);
            }

            function convertTime(value, fromUnit, toUnit) {
                const toMinutes = (val, unit) => {
                    switch (unit) {
                        case "minutos": return val;
                        case "horas": return val * 60;
                        default: throw new Error(`Unidade de tempo desconhecida: ${unit}`);
                    }
                };
                const fromMinutes = (val, unit) => {
                    switch (unit) {
                        case "minutos": return val;
                        case "horas": return val / 60;
                        default: throw new Error(`Unidade de tempo desconhecida: ${unit}`);
                    }
                };
                const valueInMinutes = toMinutes(value, fromUnit);
                return fromMinutes(valueInMinutes, toUnit);
            }

            // --- Objeto Principal: Calculadoras e suas Propriedades ---
            // Este objeto armazena todas as categorias de cálculos, subcategorias,
            // suas explicações detalhadas, estrutura de formulário e lógica de cálculo.
            const calculationConfigs = {
                // 1. Cálculos de Dose
                "Cálculos de Dose": {
                    name: "Cálculos de Dose",
                    subcategories: {
                        "Dose por Peso (mg/kg)": {
                            name: "Dose por Peso (mg/kg)", // Added name for consistent display in dropdown
                            titulo: "Dose por Peso (mg/kg)",
                            fundamento: `Calcula a dose total de um medicamento baseada no peso do paciente, crucial para pediatria e para fármacos com janela terapêutica estreita, garantindo dosagens seguras e eficazes.`,
                            formula: `Dose Total (mg) = Dose por Kg (mg/kg) × Peso (kg)`,
                            exemploClinico: `<strong>🔸 Problema:</strong><br> Um médico prescreveu 50 mg de um medicamento. O medicamento está disponível em frascos de 250 mg/5 mL. Quantos mL você deve administrar?<br><br><strong>🔹 Resolução:</strong><br><br><br><strong>1️⃣ Identificar os dados:</strong><br>  **Identificar os dados:**<br>• Dose por Kg = 10 mg/kg<br>• Peso = 15 kg<br><br><strong>2️⃣ Calcular a concentração por mL:</strong><br>  **Calcular a concentração por mL:**<br>• Concentração por mL = 250 mg / 5 mL = 50 mg/mL<br><br><strong>3️⃣ Aplicar a fórmula:</strong><br>  **Aplicar a fórmula:**<br>    Dose  (mg) = 10 mg/kg × 15 kg = 150 mg<br><br><hr><br><strong>✅ Resposta:</strong><br> A dose a ser administrada é de 150 mg. Lembre de consultar as especificações do fabricante para saber se o cálculo será para uma dose fracionada ou para dose única

Exemplo: se a bula descreve 10mg/kg por dose, uma criança de 15 kg receberá 150 mg em cada administração. Agora se a descrição é
mg/kg/dia indica a quantidade total de medicamento dada ao longo de um dia inteiro, que pode ser administrada de uma só vez ou dividida em várias doses.

Exemplo: 30 mg/kg/dia para um paciente de 15 kg resulta em 450 mg por dia. Se administrado em 3 doses, cada dose seria 150 mg`,
                            chamadaCalculadora: `Para calcular a dose por peso, informe a 'Dose por Peso' e o 'Peso do Paciente'.`,
                            observacaoImportante: `Sempre utilize o peso atual do paciente. Em pacientes obesos, a dose pode ser calculada com base no peso ideal ou peso ajustado, dependendo do medicamento.`,
                            fields: [
                                { id: "dosePorKg", label: "Dose por Peso:", type: "number", placeholder: "Ex: 10", units: ["mg/kg", "mcg/kg"], defaultUnit: "mg/kg", step: "0.01" },
                                { id: "pesoPacienteDoseKg", label: "Peso do Paciente:", type: "number", placeholder: "Ex: 15", units: ["kg", "lb"], defaultUnit: "kg", step: "0.01" }
                            ],
                            calculo: function() {
                                let dosePorKg = parseFloat(document.getElementById("dosePorKg").value);
                                let peso = parseFloat(document.getElementById("pesoPacienteDoseKg").value);

                                const unitDosePorKg = document.getElementById("dosePorKg-unit-select").value;
                                const unitPeso = document.getElementById("pesoPacienteDoseKg-unit-select").value;

                                if (isNaN(dosePorKg) || isNaN(peso) || dosePorKg <= 0 || peso <= 0) {
                                    throw new Error("Por favor, preencha todos os campos com valores numéricos válidos e maiores que zero.");
                                }

                                // Conversão para unidades base (mg/kg e kg)
                                dosePorKg = convertDosePerKgToMgPerKg(dosePorKg, unitDosePorKg);
                                peso = convertToKg(peso, unitPeso);

                                const doseTotal = dosePorKg * peso;

                                return {
                                    resultado: `Dose Total: ${doseTotal.toFixed(2)} mg`,
                                    detalhes: [
                                        `Dose por Peso Convertida: ${dosePorKg.toFixed(2)} mg/kg`,
                                        `Peso do Paciente Convertido: ${peso.toFixed(2)} kg`
                                    ]
                                };
                            },
                            referencias: []
                        },
                        "Dose por Peso Ajustado": {
                            name: "Dose por Peso Ajustado", // Added name for consistent display in dropdown
                            titulo: "Dose por Peso Ajustado",
                            fundamento: `Em pacientes obesos, a distribuição de medicamentos lipofílicos (que se acumulam em gordura) pode ser significativamente alterada devido ao aumento do tecido adiposo. Para otimizar a eficácia e segurança do tratamento, é recomendado o uso do peso ajustado (ABW - Adjusted Body Weight) ao invés do peso corporal total (TBW). Isso ajuda a evitar subdosagem (quando a dose é insuficiente) ou superdosagem (quando a dose é excessiva), condições que podem comprometer a eficácia do medicamento ou aumentar o risco de efeitos adversos.`,
                            formula: `Peso Ideal (kg) = 50 + 2.3 × (Altura em polegadas - 60) (Homens)<br>Peso Ideal (kg) = 45.5 + 2.3 × (Altura em polegadas - 60) (Mulheres)<br>Peso Ajustado (kg) = Peso Ideal + 0.4 × (Peso Real - Peso Ideal)`,
                            exemploClinico: `<strong>🔸 Problema:</strong><br> Uma mulher tem 1.65 m de altura e pesa 90 kg. O medicamento requer dosagem por peso ajustado. Qual o peso ajustado?<br><br><strong>🔹 Resolução:</strong><br><br><br><strong>1️⃣ Identificar os dados:</strong><br>  Identificar os dados:<br>• Altura = 1.65 m<br>• Peso Real = 90 kg<br>• Gênero = Feminino<br><br><strong>2️⃣ Converter Altura para polegadas:</strong><br>  Converter Altura para polegadas:<br>• 1.65 m = 165 cm. 165 cm / 2.54 cm/polegada ≈ 64.96 polegadas<br><br><strong>3️⃣ Calcular Peso Ideal (Feminino):</strong><<br>  Calcular Peso Ideal (Feminino):<br>• Peso Ideal = 45.5 + 2.3 × (64.96 - 60) = 45.5 + 2.3 × 4.96 = 45.5 + 11.41 = 56.91 kg<br><br><strong>4️⃣ Calcular Peso Ajustado:</strong><br>  Calcular Peso Ajustado:<br>• Peso Ajustado = 56.91 + 0.4 × (90 - 56.91) = 56.91 + 0.4 × 33.09 = 56.91 + 13.24 = 70.15 kg<br><br><hr><br><strong>✅ Resposta:</strong><br> O peso ajustado para essa paciente é de aproximadamente 70.15 kg. Atenção ! para o cálculo da dose por peso ajustado inserir o valor do peso obtido nesta calculadora e adicionar na calculadora anterior dose por peso.`,
                            chamadaCalculadora: `Para calcular o peso ajustado, informe o 'Peso Real', a 'Altura' e o 'Gênero' do paciente.`,
                            observacaoImportante: `O peso ajustado é usado para fármacos lipofílicos em pacientes obesos. Para medicamentos hidrofílicos, o peso ideal geralmente é o mais apropriado. Verifique as diretrizes do medicamento.`,
                            fields: [
                                { id: "pesoReal", label: "Peso Real:", type: "number", placeholder: "Ex: 90", units: ["kg", "lb"], defaultUnit: "kg", step: "0.01" },
                                { id: "altura", label: "Altura:", type: "number", placeholder: "Ex: 1.65", units: ["cm", "m", "in"], defaultUnit: "m", step: "0.01" },
                                { id: "genero", label: "Gênero:", type: "select", options: [{ value: "masculino", text: "Masculino" }, { value: "feminino", text: "Feminino" }] }
                            ],
                            calculo: function() {
                                let pesoReal = parseFloat(document.getElementById("pesoReal").value);
                                let altura = parseFloat(document.getElementById("altura").value);
                                const genero = document.getElementById("genero").value;

                                const unitPeso = document.getElementById("pesoReal-unit-select").value;
                                const unitAltura = document.getElementById("altura-unit-select").value;

                                if (isNaN(pesoReal) || isNaN(altura) || pesoReal <= 0 || altura <= 0) {
                                    throw new Error("Por favor, preencha todos os campos com valores numéricos válidos e maiores que zero.");
                                }

                                // Conversão para unidades base (kg e cm)
                                pesoReal = convertToKg(pesoReal, unitPeso);
                                altura = convertToCm(altura, unitAltura); // Converte para cm

                                const alturaEmPolegadas = altura / 2.54;

                                let pesoIdeal;
                                if (genero === "masculino") {
                                    pesoIdeal = 50 + 2.3 * (alturaEmPolegadas - 60);
                                } else { // feminino
                                    pesoIdeal = 45.5 + 2.3 * (alturaEmPolegadas - 60);
                                }

                                if (pesoIdeal <= 0) {
                                    throw new Error("O Peso Ideal calculado é zero ou negativo. Verifique a altura informada.");
                                }

                                const pesoAjustado = pesoIdeal + 0.4 * (pesoReal - pesoIdeal);

                                return {
                                    resultado: `Peso Ideal: ${pesoIdeal.toFixed(2)} kg<br>Peso Ajustado: ${pesoAjustado.toFixed(2)} kg`,
                                    detalhes: [
                                        `Peso Real Convertido: ${pesoReal.toFixed(2)} kg`,
                                        `Altura Convertida: ${altura.toFixed(2)} cm (${alturaEmPolegadas.toFixed(2)} polegadas)`,
                                        `Gênero: ${genero === "masculino" ? "Masculino" : "Feminino"}`
                                    ]
                                };
                            },
                            referencias: []
                        },
                        "Dose por Superfície Corporal (ASC)": {
                            name: "Dose por Superfície Corporal (ASC)", // Added name for consistent display in dropdown
                            titulo: "Dose por Superfície Corporal (ASC)",
                            fundamento: `A Área de Superfície Corporal (BSA - Body Surface Area) é um parâmetro fisiológico utilizado para dosagem de medicamentos, especialmente quimioterápicos e imunossupressores, pois se correlaciona melhor com o metabolismo e distribuição de fármacos do que o peso isolado. A fórmula de Mosteller é a mais comum para este cálculo.`,
                            formula: `SC (m²) = √((Peso (kg) × Altura (cm)) / 3600)<br>Dose Total = Dose por ASC (unidade/m²) &times; SC (m²)`,
                            exemploClinico: `<strong>🔸 Problema:</strong><br> Um paciente com 170 cm de altura e 70 kg de peso precisa de um medicamento na dose de 50 mg/m². Calcule a dose total.<br><br><strong>🔹 Resolução:</strong><br><br><strong>1️⃣ Calcular Superfície Corporal (SC):</strong><br>• SC (m²) = √((70 × 170) / 3600) ≈ 1.82 m²<br><br><strong>2️⃣ Calcular Dose Total:</strong><br>• Dose Total = 50 mg/m² × 1.82 m² = 91 mg<br><br><hr><br><strong>✅ Resposta:</strong><br> A dose total a ser administrada é de aproximadamente 91 mg.`,
                            chamadaCalculadora: `Informe o peso e a altura do paciente, e a dose por superfície corporal desejada.`,
                            observacaoImportante: `Sempre use medidas precisas de peso e altura. O cálculo da BSA é um passo para determinar a dose total do medicamento.`,
                            fields: [
                                { id: "pesoBSA", label: "Peso:", type: "number", placeholder: "Ex: 70", units: ["kg", "lb"], defaultUnit: "kg", step: "0.1" },
                                { id: "alturaBSA", label: "Altura:", type: "number", placeholder: "Ex: 170", units: ["cm", "m", "in"], defaultUnit: "cm", step: "0.1" },
                                { id: "dosePorASC", label: "Dose por ASC:", type: "number", placeholder: "Ex: 50", units: ["mg/m²", "mcg/m²"], defaultUnit: "mg/m²", step: "0.01" }
                            ],
                            calculo: function() {
                                let peso = parseFloat(document.getElementById("pesoBSA").value);
                                let altura = parseFloat(document.getElementById("alturaBSA").value);
                                let dosePorASC = parseFloat(document.getElementById("dosePorASC").value);

                                const unitPeso = document.getElementById("pesoBSA-unit-select").value;
                                const unitAltura = document.getElementById("alturaBSA-unit-select").value;
                                const unitDoseASC = document.getElementById("dosePorASC-unit-select").value;

                                if (isNaN(peso) || isNaN(altura) || isNaN(dosePorASC) || peso <= 0 || altura <= 0 || dosePorASC <= 0) {
                                    throw new Error("Por favor, preencha todos os campos com valores numéricos válidos e maiores que zero.");
                                }

                                peso = convertToKg(peso, unitPeso);
                                altura = convertToCm(altura, unitAltura);
                                dosePorASC = convertDosePerASCtoMgPerM2(dosePorASC, unitDoseASC);

                                const sc = Math.sqrt((peso * altura) / 3600);
                                const doseTotal = sc * dosePorASC;

                                if (isNaN(sc) || sc <= 0) {
                                    throw new Error("Não foi possível calcular a Superfície Corporal. Verifique os valores de peso e altura.");
                                }

                                return {
                                    resultado: `Superfície Corporal (SC): ${sc.toFixed(2)} m²<br>Dose Total: ${doseTotal.toFixed(2)} mg`,
                                    detalhes: [
                                        `Peso Convertido: ${peso.toFixed(2)} kg`,
                                        `Altura Convertida: ${altura.toFixed(2)} cm`,
                                        `Dose por ASC Convertida: ${dosePorASC.toFixed(2)} mg/m²`
                                    ]
                                };
                            },
                            referencias: []
                        },
                        "Dose Fracionada": {
                            name: "Dose Fracionada",
                            titulo: "Dose Fracionada",
                            fundamento: `Quando não há apresentação disponível com a dose exata prescrita — seja comprimido, ampola ou embalagem líquida — o fracionamento permite ajustar a dose.`,
                            formula: `Dose a Administrar = (Dose Prescrita / Dose Disponível) × Volume/Comprimido Disponível`,
                            exemploClinico: `<strong>🔸 Problema:</strong><br> Foi prescrito 0.25 mg de um medicamento. Você tem comprimidos de 0.5 mg. Quanto do comprimido você deve administrar?<br><br><strong>🔹 Resolução:</strong><br><br><br><strong>1️⃣ Identificar os dados:</strong><br>  **Identificar os dados:**<br>• Dose Prescrita = 0.25 mg<br>• Dose Disponível = 0.5 mg<br>• Volume/Comprimido Disponível = 1 comprimido (pois é um comprimido inteiro)<br><br><strong>2️⃣ Aplicar a fórmula:</strong><br>  Aplicar a fórmula:<br>    Dose a Administrar = (0.25 mg / 0.5 mg) × 1 comprimido = 0.5 comprimido<br><br><hr><br><strong>✅ Resposta:</strong><br> Você deve administrar 0.5 (meio) comprimido.`,
                            chamadaCalculadora: `Para calcular a dose fracionada, informe a 'Dose Prescrita', a 'Dose Disponível' e o 'Volume ou Quantidade da Apresentação'.`,
                            observacaoImportante: `Apenas fracione comprimidos se houver linha de sulco (rânula) e se o medicamento puder ser fracionado sem perda de eficácia ou dose. Para líquidos, use seringa de precisão. Caso o fragmento necessário não seja inteiro ou resulte em pedaços pequenos demais, a prática pode levar a dosagem imprecisa, perda de eficácia ou até desperdício — e nesses casos é recomendado considerar outra forma farmacêutica (ex.: solução).

🏥 Uso em Sonda
Quando o paciente recebe medicamentos por sonda (enteral), comprimidos devem ser triturados até pó fino e suspensos em água estéril.

Utilize seringas graduadas e enxágues adequados antes e após administração (ideal ≥ 15 mL) para evitar obstrução da sonda e garantir absorção eficaz 
`,
                            fields: [
                                { id: "dosePrescritaFracionada", label: "Dose Prescrita:", type: "number", placeholder: "Ex: 0.25", units: ["mg", "mcg", "g"], defaultUnit: "mg", step: "0.01" },
                                { id: "doseDisponivelFracionada", label: "Dose Disponível na Apresentação:", type: "number", placeholder: "Ex: 0.5", units: ["mg", "mcg", "g"], defaultUnit: "mg", step: "0.01" },
                                { id: "apresentacaoDisponivelFracionada", label: "Volume/Quantidade da Apresentação:", type: "number", placeholder: "Ex: 1 (comprimido) ou 5 (mL)", units: ["unidade(s)", "mL"], defaultUnit: "unidade(s)", step: "0.01" }
                            ],
                            calculo: function() {
                                let dosePrescrita = parseFloat(document.getElementById("dosePrescritaFracionada").value);
                                let doseDisponivel = parseFloat(document.getElementById("doseDisponivelFracionada").value);
                                let apresentacaoDisponivel = parseFloat(document.getElementById("apresentacaoDisponivelFracionada").value);

                                const unitDosePrescrita = document.getElementById("dosePrescritaFracionada-unit-select").value;
                                const unitDoseDisponivel = document.getElementById("doseDisponivelFracionada-unit-select").value;
                                const unitApresentacaoDisponivel = document.getElementById("apresentacaoDisponivelFracionada-unit-select").value;

                                if (isNaN(dosePrescrita) || isNaN(doseDisponivel) || isNaN(apresentacaoDisponivel) ||
                                    dosePrescrita <= 0 || doseDisponivel <= 0 || apresentacaoDisponivel <= 0) {
                                    throw new Error("Por favor, preencha todos os campos com valores numéricos válidos e maiores que zero.");
                                }

                                // Conversão para unidades base (mg e unidade/mL)
                                dosePrescrita = convertToMg(dosePrescrita, unitDosePrescrita);
                                doseDisponivel = convertToMg(doseDisponivel, unitDoseDisponivel);
                                // apresentacaoDisponivel já pode ser mL ou unidades, não precisa converter se a fórmula lida com ambos.

                                if (doseDisponivel === 0) {
                                    throw new Error("A Dose Disponível na Apresentação não pode ser zero.");
                                }

                                const doseAdministrar = (dosePrescrita / doseDisponivel) * apresentacaoDisponivel;

                                return {
                                    resultado: `Dose a Administrar: ${doseAdministrar.toFixed(2)} ${unitApresentacaoDisponivel === "mL" ? "mL" : "unidade(s)"}`,
                                    detalhes: [
                                        `Dose Prescrita Convertida: ${dosePrescrita.toFixed(2)} mg`,
                                        `Dose Disponível Convertida: ${doseDisponivel.toFixed(2)} mg`,
                                        `Volume/Quantidade da Apresentação: ${apresentacaoDisponivel.toFixed(2)} ${unitApresentacaoDisponivel}`
                                    ]
                                };
                            },
                            referencias: []
                        },
                        "Dose Recebida por Tempo de Infusão": {
                            name: "Dose Recebida por Tempo de Infusão",
                            titulo: "Dose Recebida por Tempo de Infusão (Ex: Contínua)",
                            fundamento: `Calcula a dose total de um medicamento que o paciente recebeu em um determinado período, baseando-se na concentração da solução, taxa de infusão e duração. Essencial para monitorar a administração e evitar toxicidade ou subdosagem.`,
                            formula: `Dose Recebida (mg) = (Concentração da Solução (mg/mL) × Taxa de Infusão (mL/h) × Tempo de Infusão (horas))`,
                            exemploClinico: `<strong>🔸 Problema:</strong><br> Um paciente recebeu uma infusão contínua de um medicamento a 10 mg/mL a uma taxa de 50 mL/h por 2 horas. Qual a dose total de medicamento que o paciente recebeu?<br><br><strong>🔹 Resolução:</strong><br><br><br><strong>1️⃣ Identificar os dados:</strong><br>  **Identificar os dados:**<br>• Concentração da Solução = 10 mg/mL<br>• Taxa de Infusão = 50 mL/h<br>• Tempo de Infusão = 2 horas<br><br><strong>3️⃣ Aplicar a fórmula:</strong><br>  Aplicar a fórmula:<br>    Dose Recebida (mg) = 10 mg/mL × 50 mL/h × 2 horas = 1000 mg<br><br><hr><br><strong>✅ Resposta:</strong><br> A dose total de medicamento que o paciente recebeu é de 1000 mg.`,
                            chamadaCalculadora: `Para calcular a dose recebida por tempo, informe a 'Concentração da Solução', a 'Taxa de Infusão' e o 'Tempo de Infusão'.`,
                            observacaoImportante: `Monitore de perto os pacientes, pois a dose recebida pode afetar diretamente a eficácia e segurança do tratamento, especialmente em terapias de alta potência.`,
                            fields: [
                                { id: "concentracaoSolucao", label: "Concentração da Solução:", type: "number", placeholder: "Ex: 10", units: ["mg/mL", "mcg/mL", "g/mL"], defaultUnit: "mg/mL", step: "0.01" },
                                { id: "taxaInfusaoMlH", label: "Taxa de Infusão:", type: "number", placeholder: "Ex: 50", units: ["mL/h"], defaultUnit: "mL/h", step: "0.01" },
                                { id: "tempoInfusaoDose", label: "Tempo de Infusão:", type: "number", placeholder: "Ex: 2", units: ["horas", "minutos"], defaultUnit: "horas", step: "0.01" }
                            ],
                            calculo: function() {
                                let concentracaoSolucao = parseFloat(document.getElementById("concentracaoSolucao").value);
                                let taxaInfusao = parseFloat(document.getElementById("taxaInfusaoMlH").value);
                                let tempoInfusao = parseFloat(document.getElementById("tempoInfusaoDose").value);

                                const unitConcentracao = document.getElementById("concentracaoSolucao-unit-select").value;
                                const unitTaxaInfusao = document.getElementById("taxaInfusaoMlH-unit-select").value; // Esta unidade é fixa como mL/h
                                const unitTempoInfusao = document.getElementById("tempoInfusaoDose-unit-select").value;

                                if (isNaN(concentracaoSolucao) || isNaN(taxaInfusao) || isNaN(tempoInfusao) ||
                                    concentracaoSolucao <= 0 || taxaInfusao <= 0 || tempoInfusao <= 0) {
                                    throw new Error("Por favor, preencha todos os campos com valores numéricos válidos e maiores que zero.");
                                }

                                // Convert concentration to mg/mL
                                concentracaoSolucao = convertConcentrationToMgPerMl(concentracaoSolucao, unitConcentracao);

                                // Convert time to hours
                                let tempoEmHoras = tempoInfusao;
                                if (unitTempoInfusao === "minutos") {
                                    tempoEmHoras = tempoInfusao / 60;
                                }

                                const doseRecebida = concentracaoSolucao * taxaInfusao * tempoEmHoras;

                                return {
                                    resultado: `Dose Recebida: ${doseRecebida.toFixed(2)} mg`,
                                    detalhes: [
                                        `Concentração da Solução Convertida: ${concentracaoSolucao.toFixed(2)} mg/mL`,
                                        `Taxa de Infusão: ${taxaInfusao.toFixed(2)} mL/h`,
                                        `Tempo de Infusão Convertido: ${tempoEmHoras.toFixed(2)} horas`
                                    ]
                                };
                            },
                            referencias: []
                        }
                    }
                },
                // 2. Cálculos de Volume e Concentração (Consolidado)
                "Cálculos de Volume e Concentração": {
                    name: "Cálculos de Volume e Concentração",
                    subcategories: {
                        "Volume da Dose Desejada": {
                            name: "Volume da Dose Desejada",
                            titulo: "Volume de Dose Desejada",
                            fundamento: `Calcula o volume de uma solução ou medicamento necessário para uma dose específica. É um dos cálculos mais básicos e frequentes na prática clínica, garantindo que a quantidade correta do fármaco seja entregue ao paciente.`,
                            formula: `Volume Desejado (mL) = (Dose Prescrita (mg) / Concentração Disponível (mg/mL))`,
                            exemploClinico: `<strong>🔸 Problema:</strong><br> Um médico prescreveu 50 mg de um medicamento. O medicamento está disponível em frascos de 250 mg/5 mL. Quantos mL você precisa para obter a dose desejada prescrita ?<br><br><strong>🔹 Resolução:</strong><br><br><br><strong>1️⃣ Identificar os dados:</strong><br>  Identificar os dados:<br>• Dose Prescrita = 50 mg<br>• Concentração Disponível = 250 mg/5 mL<br><br><strong>2️⃣ Calcular a concentração por mL:</strong><br>  Calcular a concentração por mL:<br>• Concentração por mL = 250 mg / 5 mL = 50 mg/mL<br><br><strong>3️⃣ Aplicar a fórmula:</strong><br>  Aplicar a fórmula:<br>    Volume Desejado (mL) = 50 mg / 50 mg/mL = 1 mL<br><br><hr><br><strong>✅ Resposta:</strong><br> O volume para a dose desejada é 1 mL do medicamento `,
                            chamadaCalculadora: `Para calcular o volume da dose desejada, informe a 'Dose Prescrita' e a 'Concentração do Medicamento'.`,
                            observacaoImportante: `Sempre verifique a concentração do medicamento no rótulo e, se necessário, converta as unidades para que sejam consistentemente antes de aplicar a fórmula. 📌 Atenção: o volume resultante do cálculo da dose desejada prescrita não necessariamente será o volume administrado diretamente ao paciente. Esse valor é um volume de referência, que pode precisar de diluição dependendo do medicamento e das recomendações específicas do fabricante.No entanto, essa distinção não altera a dose real de medicamento administrada."`,
                            fields: [
                                { id: "dosePrescrita", label: "Dose Prescrita:", type: "number", placeholder: "Ex: 50", units: ["mg", "mcg", "g"], defaultUnit: "mg", step: "0.01" },
                                { id: "concentracaoDisponivel", label: "Concentração do Medicamento:", type: "number", placeholder: "Ex: 250", units: ["mg", "mcg", "g"], defaultUnit: "mg", step: "0.01" },
                                { id: "volumeDisponivel", label: "Volume Total da Apresentação:", type: "number", placeholder: "Ex: 5", units: ["mL", "L"], defaultUnit: "mL", step: "0.01" }
                            ],
                            calculo: function() {
                                let dosePrescrita = parseFloat(document.getElementById("dosePrescrita").value);
                                let concentracaoDisponivel = parseFloat(document.getElementById("concentracaoDisponivel").value);
                                let volumeDisponivel = parseFloat(document.getElementById("volumeDisponivel").value);

                                const unitDose = document.getElementById("dosePrescrita-unit-select").value;
                                const unitConcentracao = document.getElementById("concentracaoDisponivel-unit-select").value;
                                const unitVolume = document.getElementById("volumeDisponivel-unit-select").value;

                                if (isNaN(dosePrescrita) || isNaN(concentracaoDisponivel) || isNaN(volumeDisponivel) ||
                                    dosePrescrita <= 0 || concentracaoDisponivel <= 0 || volumeDisponivel <= 0) {
                                    throw new Error("Por favor, preencha todos os campos com valores numéricos válidos e maiores que zero.");
                                }

                                // Conversão para unidades base (mg e mL)
                                dosePrescrita = convertToMg(dosePrescrita, unitDose);
                                concentracaoDisponivel = convertToMg(concentracaoDisponivel, unitConcentracao);
                                volumeDisponivel = convertToMl(volumeDisponivel, unitVolume);

                                if (volumeDisponivel === 0) {
                                    throw new Error("O Volume Total da Apresentação não pode ser zero.");
                                }

                                const concentracaoPorMl = concentracaoDisponivel / volumeDisponivel;

                                if (concentracaoPorMl === 0) {
                                    throw new Error("A concentração do medicamento é zero, verifique os valores informados.");
                                }

                                const volumeDesejado = dosePrescrita / concentracaoPorMl;

                                return {
                                    resultado: `Volume da dose desejada: ${volumeDesejado.toFixed(2)} mL`,
                                    detalhes: [
                                        `Dose Prescrita: ${dosePrescrita.toFixed(2)} mg`,
                                        `Concentração Disponível : ${concentracaoDisponivel.toFixed(2)} mg`,
                                        `Volume Disponível : ${volumeDisponivel.toFixed(2)} mL`,
                                        `Concentração por mL: ${concentracaoPorMl.toFixed(2)} mg/mL`
                                    ]
                                };
                            },
                            referencias: []
                        },
                        "Reconstituição e Dosagem": {
                            name: "Reconstituição e Dosagem",
                            titulo: "Reconstituição e Dosagem",
                            fundamento: `Em muitas situações, o medicamento não vem pronto para uso, mas sim na forma de pó liofilizado ou concentrado (frasco-ampola). Nesses casos, é necessária a reconstituição — um processo crítico que consiste em:

Adicionar um diluente apropriado  ao frasco-ampola contendo o pó. Este cálculo permite calcular a concentração reconstituida e o volume de dose desejada pós reconstituição.`,
                            formula: `Concentração Reconstituída (mg/mL) = Dose Total do Frasco (mg) / Volume do Diluente (mL)<br>Volume da dose desejada (mL) = Dose Prescrita (mg) / Concentração Reconstituída (mg/mL)`,
                            exemploClinico: `<strong>🔸 Problema:</strong><br> Um frasco de medicamento contém 500 mg de pó. O fabricante recomenda reconstituir com 5 mL de diluente. A dose prescrita é de 100 mg. Qual a concentração reconstituída e o volume da dose desejada prescrita ?<br><br><strong>🔹 Resolução:</strong><br><br><br><strong>1️⃣ Identificar os dados:</strong><br>  **Identificar os dados:**<br>• Dose Total do Frasco = 500 mg<br>• Volume do Diluente = 5 mL<br>• Dose Prescrita = 100 mg<br><br><strong>2️⃣ Calcular a Concentração Reconstituída:</strong><br>  Calcular a Concentração Reconstituída:<br>• Concentração Reconstituída (mg/mL) = 500 mg / 5 mL = 100 mg/mL<br><br><strong>3️⃣ Calcular o Volume da dose desejada prescrita :</strong><br>  Calcular o Volume da dose desejada prescrita:<br>• Volume da dose desejada prescrita (mL) = 100 mg / 100 mg/mL = 1 mL<br><br><hr><br><strong>✅ Resposta:</strong><br> A concentração reconstituída é de 100 mg/mL e o volume da dose desejada prescrita será 1 mL.`,
                            chamadaCalculadora: `Para o cálculo de reconstituição, informe a 'Dose Total do Frasco', o 'Volume do Diluente' e a 'Dose Prescrita'.`,
                            observacaoImportante: `Sempre siga as orientações do fabricante para reconstituição, incluindo o tipo e volume de diluente. A estabilidade do medicamento reconstituído pode variar. Lembre também que o volume da dose desejada prescrita não necessariamente será o volume administrado diretamente ao paciente. Esse valor é um volume de referência, que pode precisar de diluição dependendo do medicamento e das recomendações específicas do fabricante.No entanto, essa distinção não altera a dose real de medicamento administrada."`,
                            fields: [
                                { id: "doseTotalFrasco", label: "Dose Total do Frasco (Pó):", type: "number", placeholder: "Ex: 500", units: ["mg", "mcg", "g"], defaultUnit: "mg", step: "0.01" },
                                { id: "volumeDiluente", label: "Volume do Diluente:", type: "number", placeholder: "Ex: 5", units: ["mL", "L"], defaultUnit: "mL", step: "0.01" },
                                { id: "dosePrescritaReconstituicao", label: "Dose Prescrita:", type: "number", placeholder: "Ex: 100", units: ["mg", "mcg", "g"], defaultUnit: "mg", step: "0.01" }
                            ],
                            calculo: function() {
                                let doseTotalFrasco = parseFloat(document.getElementById("doseTotalFrasco").value);
                                let volumeDiluente = parseFloat(document.getElementById("volumeDiluente").value);
                                let dosePrescrita = parseFloat(document.getElementById("dosePrescritaReconstituicao").value);

                                const unitDoseFrasco = document.getElementById("doseTotalFrasco-unit-select").value;
                                const unitVolumeDiluente = document.getElementById("volumeDiluente-unit-select").value;
                                const unitDosePrescrita = document.getElementById("dosePrescritaReconstituicao-unit-select").value;

                                if (isNaN(doseTotalFrasco) || isNaN(volumeDiluente) || isNaN(dosePrescrita) ||
                                    doseTotalFrasco <= 0 || volumeDiluente <= 0 || dosePrescrita <= 0) {
                                    throw new Error("Por favor, preencha todos os campos com valores numéricos válidos e maiores que zero.");
                                }

                                // Conversão para unidades base (mg e mL)
                                doseTotalFrasco = convertToMg(doseTotalFrasco, unitDoseFrasco);
                                volumeDiluente = convertToMl(volumeDiluente, unitVolumeDiluente);
                                dosePrescrita = convertToMg(dosePrescrita, unitDosePrescrita);

                                if (volumeDiluente === 0) {
                                    throw new Error("O Volume do Diluente não pode ser zero.");
                                }

                                const concentracaoReconstituida = doseTotalFrasco / volumeDiluente;

                                if (concentracaoReconstituida === 0) {
                                    throw new Error("A Concentração Reconstituída é zero. Verifique a Dose Total do Frasco e o Volume do Diluente.");
                                }

                                const volumeAdministrar = dosePrescrita / concentracaoReconstituida;

                                return {
                                    resultado: `Concentração Reconstituída: ${concentracaoReconstituida.toFixed(2)} mg/mL<br>Volume de dose desejada: ${volumeAdministrar.toFixed(2)} mL`,
                                    detalhes: [
                                        `Dose Total do Frasco : ${doseTotalFrasco.toFixed(2)} mg`,
                                        `Volume do Diluente : ${volumeDiluente.toFixed(2)} mL`,
                                        `Dose Prescrita : ${dosePrescrita.toFixed(2)} mg`
                                    ]
                                };
                            },
                            referencias: []
                        },
                        "Concentração Percentual (% m/v)": {
                            name: 'Concentração Percentual (% m/v)',
                            titulo: 'Concentração Percentual (% m/v)',
                            fundamento: `Calcula a concentração de uma solução em porcentagem massa por volume (% m/v), que representa a quantidade de soluto (em gramas) presente em 100 mL de solução.`,
                            formula: `Concentração (% m/v) = (Massa do Soluto (g) / Volume da Solução (mL)) × 100`,
                            exemploClinico: `<strong>🔸 Problema:</strong><br> Você dissolveu 5 gramas de NaCl em água para fazer 100 mL de solução. Qual a concentração percentual (m/v)?<br><br><strong>🔹 Resolução:</strong><br>• Concentração = (5 g / 100 mL) × 100 = 5% m/v<br><br><hr><br><strong>✅ Resposta:</strong><br> A concentração é 5% m/v.`,
                            chamadaCalculadora: `Informe a 'Massa do Soluto' em gramas e o 'Volume da Solução' em mililitros.`,
                            observacaoImportante: `Certifique-se de que as unidades de massa e volume estejam em gramas e mililitros, respectivamente, para um cálculo correto.`,
                            fields: [
                                { id: 'soluteMass', label: 'Massa do Soluto (g):', type: 'number', placeholder: 'Ex: 5', step: "0.01" },
                                { id: 'solutionVolume', label: 'Volume da Solução (mL):', type: 'number', placeholder: 'Ex: 100', step: "0.01" }
                            ],
                            calculo: function() {
                                const soluteMass = parseFloat(document.getElementById('soluteMass').value);
                                const solutionVolume = parseFloat(document.getElementById('solutionVolume').value);
                                if (isNaN(soluteMass) || isNaN(solutionVolume) || solutionVolume === 0 || soluteMass < 0 || solutionVolume < 0) {
                                    throw new Error('Por favor, insira valores válidos e positivos para Massa do Soluto e Volume da Solução.');
                                }
                                const result = (soluteMass / solutionVolume) * 100;
                                return { resultado: `A concentração é ${result.toFixed(2)} % m/v.`, color: 'green' };
                            },
                            referencias: []
                        },
                        "Molaridade (mol/L)": {
                            name: 'Molaridade (mol/L)',
                            titulo: 'Molaridade (mol/L)',
                            fundamento: `A molaridade é uma medida de concentração que expressa o número de moles de soluto por litro de solução. É amplamente utilizada em química e farmacologia para expressar a concentração de substâncias em soluções.`,
                            formula: `Molaridade (mol/L) = Moles do Soluto (mol) / Volume da Solução (L)`,
                            exemploClinico: `<strong>🔸 Problema:</strong><br> Você dissolveu 0.1 mol de glicose para fazer 0.5 L de solução. Qual a molaridade?<br><br><strong>🔹 Resolução:</strong><br>• Molaridade = 0.1 mol / 0.5 L = 0.2 mol/L<br><br><hr><br><strong>✅ Resposta:</strong><br> A molaridade é 0.2 mol/L.`,
                            chamadaCalculadora: `Informe os 'Moles do Soluto' em mol e o 'Volume da Solução' em litros.`,
                            observacaoImportante: `Certifique-se de que o volume da solução esteja em litros. Se tiver a massa do soluto, precisará do peso molecular para converter em moles.`,
                            fields: [
                                { id: 'soluteMoles', label: 'Moles do Soluto (mol):', type: 'number', placeholder: 'Ex: 0.1', step: "0.01" },
                                { id: 'solutionVolumeL', label: 'Volume da Solução (L):', type: 'number', placeholder: 'Ex: 0.5', step: "0.01" }
                            ],
                            calculo: function() {
                                const soluteMoles = parseFloat(document.getElementById('soluteMoles').value);
                                const solutionVolumeL = parseFloat(document.getElementById('solutionVolumeL').value);
                                if (isNaN(soluteMoles) || isNaN(solutionVolumeL) || solutionVolumeL === 0 || soluteMoles < 0 || solutionVolumeL < 0) {
                                    throw new Error('Por favor, insira valores válidos e positivos para Moles do Soluto e Volume da Solução.');
                                }
                                const result = soluteMoles / solutionVolumeL;
                                return { resultado: `A molaridade é ${result.toFixed(2)} mol/L.`, color: 'green' };
                            },
                            referencias: []
                        },
                        "Concentração Final após Diluição (C1V1=C2V2)": {
                            name: "Concentração Final após Diluição (C1V1=C2V2)",
                            titulo: "Cálculo de Diluição (C1V1=C2V2)",
                            fundamento: `A equação C1V1 = C2V2 é fundamental para manipulações farmacêuticas, permitindo calcular uma variável desconhecida (concentração ou volume) quando as outras três são conhecidas. É crucial para preparar soluções com a concentração terapêutica desejada, garantindo a segurança e eficácia do tratamento.`,
                            formula: `A fórmula geral é C1V1 = C2V2, onde:<br>
                            C1 = Concentração Inicial<br>
                            V1 = Volume Inicial<br>
                            C2 = Concentração Final<br>
                            V2 = Volume Final<br><br>
                            Você pode calcular qualquer uma das variáveis isolando-a:
                            <ul>
                                <li>C1 = (C2 × V2) / V1</li>
                                <li>V1 = (C2 × V2) / C1</li>
                                <li>C2 = (C1 × V1) / V2</li>
                                <li>V2 = (C1 × V1) / C2</li>
                            </ul>
                            `,
                            exemploClinico: `<strong>🔸 Exemplo para Calcular C2:</strong><br> Você tem uma solução de 200 mg/mL (C1) e precisa diluí-la. Se você pegar 5 mL (V1) dessa solução e adicionar diluente até atingir um volume final de 100 mL (V2), qual será a concentração final (C2)?<br><br><strong>🔹 Resolução:</strong><br>• C2 = (200 mg/mL × 5 mL) / 100 mL = 10 mg/mL<br><br><strong>✅ Resposta:</strong><br> A concentração final será de 10 mg/mL.<br><hr><br><strong>Para outros cálculos (C1, V1, V2), a lógica é similar, rearranjando a fórmula para isolar a variável desejada.</strong>`,
                            chamadaCalculadora: `Selecione qual variável você deseja calcular e informe os outros três valores. Certifique-se de que as unidades de concentração (C) sejam as mesmas e as unidades de volume (V) também sejam as mesmas, para garantir resultados consistentes.`,
                            observacaoImportante: `Sempre adicione o concentrado ao diluente, e não o contrário, para garantir a homogeneidade da solução. Verifique a compatibilidade dos diluentes e a estabilidade da nova concentração. Descarte adequadamente qualquer excesso. Unidades devem ser consistentemente (ex: se C1 é mg/mL, C2 também será mg/mL).`,
                            fields: [
                                {
                                    id: "variableToCalculate",
                                    label: "Calcular Qual Variável?",
                                    type: "select",
                                    options: [
                                        { value: "C2", text: "Concentração Final (C2)" },
                                        { value: "C1", text: "Concentração Inicial (C1)" },
                                        { value: "V1", text: "Volume Inicial (V1)" },
                                        { value: "V2", text: "Volume Final (V2)" }
                                    ],
                                    defaultUnit: "C2" // This isn't a unit, but used to set default selection
                                },
                                { id: "c1Value", label: "Concentração Inicial (C1):", type: "number", placeholder: "Ex: 200", units: ["mg/mL", "mcg/mL", "g/mL", "%"], defaultUnit: "mg/mL", step: "0.01", hideFor: ["C1"] },
                                { id: "v1Value", label: "Volume Inicial (V1):", type: "number", placeholder: "Ex: 5", units: ["mL", "L"], defaultUnit: "mL", step: "0.01", hideFor: ["V1"] },
                                { id: "c2Value", label: "Concentração Final (C2):", type: "number", placeholder: "Ex: 10", units: ["mg/mL", "mcg/mL", "g/mL", "%"], defaultUnit: "mg/mL", step: "0.01", hideFor: ["C2"] },
                                { id: "v2Value", label: "Volume Final (V2):", type: "number", placeholder: "Ex: 100", units: ["mL", "L"], defaultUnit: "mL", step: "0.01", hideFor: ["V2"] }
                            ],
                            calculo: function() {
                                const variableToCalculate = document.getElementById("variableToCalculate").value;

                                let c1 = parseFloat(document.getElementById("c1Value").value);
                                let v1 = parseFloat(document.getElementById("v1Value").value);
                                let c2 = parseFloat(document.getElementById("c2Value").value);
                                let v2 = parseFloat(document.getElementById("v2Value").value);

                                // Get units
                                const unitC1 = document.getElementById("c1Value-unit-select").value;
                                const unitV1 = document.getElementById("v1Value-unit-select").value;
                                const unitC2 = document.getElementById("c2Value-unit-select").value;
                                const unitV2 = document.getElementById("v2Value-unit-select").value;

                                let resultValue;
                                let resultUnit;
                                let details = [];

                                try {
                                    // Convert known values to base units (mg/mL for concentrations, mL for volumes)
                                    if (variableToCalculate !== "C1") {
                                        c1 = convertConcentrationToMgPerMl(c1, unitC1);
                                        details.push(`C1 (Convertido para base): ${c1.toFixed(4)} mg/mL`);
                                    }
                                    if (variableToCalculate !== "V1") {
                                        v1 = convertToMl(v1, unitV1);
                                        details.push(`V1 (Convertido para base): ${v1.toFixed(4)} mL`);
                                    }
                                    if (variableToCalculate !== "C2") {
                                        c2 = convertConcentrationToMgPerMl(c2, unitC2);
                                        details.push(`C2 (Convertido para base): ${c2.toFixed(4)} mg/mL`);
                                    }
                                    if (variableToCalculate !== "V2") {
                                        v2 = convertToMl(v2, unitV2);
                                        details.push(`V2 (Convertido para base): ${v2.toFixed(4)} mL`);
                                    }

                                    // Perform calculation based on `variableToCalculate`
                                    switch (variableToCalculate) {
                                        case "C2":
                                            if (isNaN(c1) || isNaN(v1) || isNaN(v2) || c1 <= 0 || v1 <= 0 || v2 <= 0) {
                                                throw new Error("Para calcular C2, preencha C1, V1 e V2 com valores numéricos válidos e maiores que zero para concentrações e volumes.");
                                            }
                                            resultValue = (c1 * v1) / v2;
                                            resultUnit = unitC2; // Use the selected output unit for C2
                                            details.unshift(`Variável Calculada: Concentração Final (C2)`);
                                            break;
                                        case "C1":
                                            if (isNaN(c2) || isNaN(v1) || isNaN(v2) || c2 <= 0 || v1 <= 0 || v2 <= 0) {
                                                throw new Error("Para calcular C1, preencha C2, V1 e V2 com valores numéricos válidos e maiores que zero para concentrações e volumes.");
                                            }
                                            if (v1 === 0) throw new Error("V1 não pode ser zero para calcular C1.");
                                            resultValue = (c2 * v2) / v1;
                                            resultUnit = unitC1; // Use the selected output unit for C1
                                            details.unshift(`Variável Calculada: Concentração Inicial (C1)`);
                                            break;
                                        case "V1":
                                            if (isNaN(c1) || isNaN(c2) || isNaN(v2) || c1 <= 0 || c2 <= 0 || v2 <= 0) {
                                                throw new Error("Para calcular V1, preencha C1, C2 e V2 com valores numéricos válidos e maiores que zero para concentrações e volume.");
                                            }
                                            if (c1 === 0) throw new Error("C1 não pode ser zero para calcular V1.");
                                            resultValue = (c2 * v2) / c1;
                                            resultUnit = unitV1; // Use the selected output unit for V1
                                            details.unshift(`Variável Calculada: Volume Inicial (V1)`);
                                            break;
                                        case "V2":
                                            if (isNaN(c1) || isNaN(v1) || isNaN(c2) || c1 <= 0 || v1 <= 0 || c2 <= 0) {
                                                throw new Error("Para calcular V2, preencha C1, V1 e C2 com valores numéricos válidos e maiores que zero para concentrações e volume.");
                                            }
                                            if (c2 === 0) throw new Error("C2 não pode ser zero para calcular V2.");
                                            resultValue = (c1 * v1) / c2;
                                            resultUnit = unitV2; // Use the selected output unit for V2
                                            details.unshift(`Variável Calculada: Volume Final (V2)`);
                                            break;
                                        default:
                                            throw new Error("Selecione uma variável para calcular.");
                                    }

                                    // Convert result back to the selected output unit from base units
                                    if (variableToCalculate === "C1" || variableToCalculate === "C2") {
                                        resultValue = convertFromMgPerMl(resultValue, resultUnit);
                                    } else if (variableToCalculate === "V1" || variableToCalculate === "V2") {
                                        resultValue = convertFromMl(resultValue, resultUnit);
                                    }

                                    // Ensure the result is positive
                                    if (resultValue < 0) {
                                        throw new Error("O resultado do cálculo é negativo. Verifique os valores de entrada.");
                                    }

                                    return {
                                        resultado: `${variableToCalculate}: ${resultValue.toFixed(4)} ${resultUnit}`,
                                        detalhes: details
                                    };

                                } catch (error) {
                                    throw error;
                                }
                            },
                            referencias: []
                        },
                        "Transformação de Soro": {
                            name: "Transformação de Soro",
                            titulo: "Transformação de Soro",
                            fundamento: `Calcula os volumes necessários de um soluto concentrado e de um soro base para preparar uma solução final com uma concentração e volume desejados. Este cálculo é fundamental para a manipulação e preparação de soluções intravenosas na prática clínica.`,
                            formula: `Quantidade de Soluto (g) = (Volume Final (mL) × Concentração Desejada (%)) / 100<br>Volume do Soluto Concentrado (mL) = (Quantidade de Soluto (g) × 100) / Concentração do Soluto (%)<br>Volume do Soro Base (mL) = Volume Final (mL) - Volume do Soluto Concentrado (mL)`,
                            exemploClinico: `<strong>🔸 Problema:</strong><br> Paciente feminino, 65 anos, admitida na UTI com quadro de pneumonia grave associada à insuficiência respiratória aguda, em uso de antibióticos, ventilação mecânica e suporte venoso.

Durante a evolução, apresentou hipoglicemia recorrente (glicemia capilar 52 mg/dL) devido à restrição nutricional enteral nas últimas 12 horas, associada ao uso de insulina para controle glicêmico prévio.

O médico prescreve rapidamente:
➡️ Soro Glicosado 10% 500 mL EV em infusão contínua.

Porém, ao checar o estoque da farmácia e da unidade, não há SG 10% disponível, apenas:

Ampolas de SG 50% (10 mL cada)

Soro fisiológico 0,9% em bolsas de 500 mL.<br><br><strong>🔹 Resolução:</strong><br><br><br><strong>1️⃣ Identificar os dados:</strong><br>• Volume Final Desejado = 500 mL<br>• Concentração Desejada = 10%<br>• Concentração do Soluto Disponível = 50%<br><br><strong>2️⃣ Aplicar a fórmula:</strong><br>  Calcular a Quantidade de Soluto Necessária:<br>• Quantidade de Soluto (g) = (500 mL × 10%) / 100 = 50 g<br><br><strong>3️⃣ Resultado:</strong><br>  Calcular o Volume da Glicose 50% Necessário:**<br>• Volume Glicose 50% (mL) = (50 g × 100) / 50% = 100 mL(10 ampolas)<br><br>4.  Calcular o Volume do Soro Base (para Volume Final de 500 mL):<br>• Volume do Soro Base (mL) = 500 mL - 100 mL = 400 mL<br><br><hr><br><strong>✅ Resposta:</strong><br> Para obter 500 mL de Glicose 10%, adicione 100 mL (10 ampolas) de Glicose 50% a 400 mL de soro base.`,
                            chamadaCalculadora: `Para transformar o soro, informe o 'Volume Desejado da Solução Final', a 'Concentração Desejada' e a 'Concentração do Soluto' que você tem disponível.`,
                            observacaoImportante: `Este cálculo é para transformar um soro em outro, onde o volume final da solução é o objetivo. É crucial entender se a porcentagem do soluto é em peso/volume (g/100mL) ou apenas porcentagem. Sempre use técnica asséptica e siga as diretrizes de compatibilidade.`,
                            fields: [
                                { id: "volumeFinalTS", label: "Volume Desejado da Solução Final:", type: "number", placeholder: "Ex: 500", units: ["mL", "L"], defaultUnit: "mL", step: "0.01" },
                                { id: "concentracaoDesejadaTS", label: "Concentração Desejada da Solução Final:", type: "number", placeholder: "Ex: 10", units: ["%", "g/mL"], defaultUnit: "%", step: "0.01" },
                                { id: "concentracaoSolutoTS", label: "Concentração do Soluto Disponível:", type: "number", placeholder: "Ex: 50", units: ["%", "g/mL"], defaultUnit: "%", step: "0.01" }
                            ],
                            calculo: function() {
                                const volumeFinalInput = document.getElementById("volumeFinalTS");
                                const concentracaoDesejadaInput = document.getElementById("concentracaoDesejadaTS");
                                const concentracaoSolutoInput = document.getElementById("concentracaoSolutoTS");

                                let volumeFinal = parseFloat(volumeFinalInput.value);
                                let concentracaoDesejada = parseFloat(concentracaoDesejadaInput.value);
                                let concentracaoSoluto = parseFloat(concentracaoSolutoInput.value);

                                const unitVolumeFinal = document.getElementById("volumeFinalTS-unit-select").value;
                                const unitConcentracaoDesejada = document.getElementById("concentracaoDesejadaTS-unit-select").value;
                                const unitConcentracaoSoluto = document.getElementById("concentracaoSolutoTS-unit-select").value;

                                if (isNaN(volumeFinal) || isNaN(concentracaoDesejada) || isNaN(concentracaoSoluto) || volumeFinal <= 0 || concentracaoSoluto <= 0 || concentracaoDesejada < 0) {
                                    throw new Error("Por favor, preencha todos os campos com valores numéricos válidos e certifique-se que 'Volume Desejado da Solução Final' e 'Concentração do Soluto Disponível' são maiores que zero. A 'Concentração Desejada' deve ser maior ou igual a zero.");
                                }

                                // Conversão de unidades para os campos com unidade selecionável
                                volumeFinal = convertToMl(volumeFinal, unitVolumeFinal);
                                // convertPercentageToDecimal retorna o valor da porcentagem como número, a divisão por 100 é feita na fórmula.
                                concentracaoDesejada = convertPercentageToDecimal(concentracaoDesejada, unitConcentracaoDesejada);
                                concentracaoSoluto = convertPercentageToDecimal(concentracaoSoluto, unitConcentracaoSoluto);

                                if (concentracaoSoluto === 0) {
                                    throw new Error("A Concentração do Soluto Disponível não pode ser zero ou negativa.");
                                }
                                if (concentracaoDesejada > concentracaoSoluto) {
                                    throw new Error("A Concentração Desejada não pode ser maior que a Concentração do Concentrado.");
                                }

                                // A quantidade de soluto necessária em gramas para o volume final desejado
                                const quantidadeSolutoGramas = (volumeFinal * (concentracaoDesejada / 100)); // Aqui concentracaoDesejada é a porcentagem informada pelo usuário

                                // O volume do soluto concentrado necessário
                                const volumeSolutoNecessario = (quantidadeSolutoGramas * 100) / concentracaoSoluto;

                                const volumeSoroBase = volumeFinal - volumeSolutoNecessario;

                                if (volumeSoroBase < 0) {
                                    throw new Error("Volume do soluto necessário excede o volume final desejado. Verifique as concentrações.");
                                }

                                return {
                                    resultado: `Volume do Soluto a Adicionar: ${volumeSolutoNecessario.toFixed(2)} mL<br>Volume do Soro Base Necessário: ${volumeSoroBase.toFixed(2)} mL`,
                                    detalhes: [
                                        `Volume Final Desejado Convertido: ${volumeFinal.toFixed(2)} mL`,
                                        `Concentração Desejada Convertida: ${concentracaoDesejada.toFixed(2)} %`,
                                        `Concentração do Soluto Convertida: ${concentracaoSoluto.toFixed(2)} %`
                                    ]
                                };
                            },
                            referencias: []
                        },
                    }
                },
                // 3. Cálculos de Infusão e Gotejamento
                "Cálculos de Infusão e Gotejamento": {
                    name: "Cálculos de Infusão e Gotejamento",
                    subcategories: {
                        "Taxa de Infusão (mL/h)": {
                            titulo: "Taxa de Infusão (mL/h)",
                            fundamento: `Calcula a taxa de infusão de uma solução ou medicamento em mililitros por hora (mL/h) ou mililitros por minuto (mL/min), fundamental para a programação precisa de bombas de infusão e administração de fluidos.`,
                            formula: `Taxa de Infusão (mL/h) = Volume Total (mL) / Tempo de Infusão (horas)`,
                            exemploClinico: `<strong>🔸 Problema:</strong><br> Uma solução de 500 mL deve ser infundida em 4 horas utilizando um equipo de macrogotas. Qual deve ser a taxa de infusão em mL/h?<br><br><strong>🔹 Resolução:</strong><br><br><br><strong>1️⃣ Identificar os dados:</strong><br>• Volume Total = 500 mL<br>• Tempo de Infusão = 4 horas<br><br><strong>2️⃣ Aplicar a fórmula:</strong><br>  Aplicar a fórmula:<br>    Taxa de Infusão (mL/h) = 500 mL / 4 horas = 125 mL/h<br><br><hr><br><strong>✅ Resposta:</strong><br> A taxa de infusão deve ser de 125 mL/h.`,
                            chamadaCalculadora: `Para calcular a taxa de infusão, informe o 'Volume Total' e o 'Tempo de Infusão'.`,
                            observacaoImportante: `Sempre verifique a compatibilidade do medicamento com o diluente e a estabilidade da solução. A taxa de infusão deve ser ajustada conforme a resposta do paciente.`,
                            fields: [
                                { id: "volumeTotalInfusao", label: "Volume Total da Solução:", type: "number", placeholder: "Ex: 500", units: ["mL", "L"], defaultUnit: "mL", step: "0.01" },
                                { id: "tempoInfusao", label: "Tempo de Infusão:", type: "number", placeholder: "Ex: 4", units: ["horas", "minutos"], defaultUnit: "horas", step: "0.01" }
                            ],
                            calculo: function() {
                                let volumeTotal = parseFloat(document.getElementById("volumeTotalInfusao").value);
                                let tempoInfusao = parseFloat(document.getElementById("tempoInfusao").value);

                                const unitVolume = document.getElementById("volumeTotalInfusao-unit-select").value;
                                const unitTempo = document.getElementById("tempoInfusao-unit-select").value;

                                if (isNaN(volumeTotal) || isNaN(tempoInfusao) || volumeTotal <= 0 || tempoInfusao <= 0) {
                                    throw new Error("Por favor, preencha todos os campos com valores numéricos válidos e maiores que zero.");
                                }

                                // Conversão para unidades base (mL e horas)
                                volumeTotal = convertToMl(volumeTotal, unitVolume);
                                // Convert tempo para horas se estiver em minutos
                                let tempoEmHoras = tempoInfusao;
                                if (unitTempo === "minutos") {
                                    tempoEmHoras = tempoInfusao / 60;
                                }

                                if (tempoEmHoras === 0) {
                                    throw new Error("O Tempo de Infusão não pode ser zero.");
                                }

                                const taxaInfusao = volumeTotal / tempoEmHoras;

                                return {
                                    resultado: `Taxa de Infusão: ${taxaInfusao.toFixed(2)} mL/h`,
                                    detalhes: [
                                        `Volume Total Convertido: ${volumeTotal.toFixed(2)} mL`,
                                        `Tempo de Infusão Convertido: ${tempoEmHoras.toFixed(2)} horas`
                                    ]
                                };
                            },
                            referencias: []
                        },
                        "Tempo de Infusão": {
                            titulo: "Tempo de Infusão",
                            fundamento: `Calcula o tempo necessário para infundir um volume específico de solução a uma determinada taxa de infusão. Essencial para o planejamento da administração de medicamentos e fluidos, garantindo que o tratamento seja concluído dentro do período desejado.`,
                            formula: `Tempo de Infusão (horas) = Volume Total (mL) / Taxa de Infusão (mL/h)`,
                            exemploClinico: `<strong>🔸 Problema:</strong><br> Um paciente precisa receber 500 mL de soro fisiológico a uma taxa de 125 mL/h. Quanto tempo levará a infusão?<br><br><strong>🔹 Resolução:</strong><br><br><br><strong>1️⃣ Identificar os dados:</strong><br>• Volume Total = 500 mL<br>• Taxa de Infusão = 125 mL/h<br><br><strong>2️⃣ Aplicar a fórmula:</strong><br>  Aplicar a fórmula:<br>    Tempo de Infusão (horas) = 500 mL / 125 mL/h = 4 horas<br><br><hr><br><strong>✅ Resposta:</strong><br> A infusão levará 4 horas (240 minutos).`,
                            chamadaCalculadora: `Para calcular o tempo de infusão, informe o 'Volume Total da Solução' e a 'Taxa de Infusão'.`,
                            observacaoImportante: `Sempre arredonde o tempo para a unidade prática mais próxima (minutos ou horas). Considere a estabilidade do medicamento e o estado clínico do paciente ao determinar a duração da infusão.`,
                            fields: [
                                { id: "volumeTotalTempoInfusao", label: "Volume Total da Solução:", type: "number", placeholder: "Ex: 500", units: ["mL", "L"], defaultUnit: "mL", step: "0.01" },
                                { id: "taxaInfusaoTempoInfusao", label: "Taxa de Infusão:", type: "number", placeholder: "Ex: 125", units: ["mL/h", "mL/min", "L/h"], defaultUnit: "mL/h", step: "0.01" }
                            ],
                            calculo: function() {
                                let volumeTotal = parseFloat(document.getElementById("volumeTotalTempoInfusao").value);
                                let taxaInfusao = parseFloat(document.getElementById("taxaInfusaoTempoInfusao").value);

                                const unitVolumeTotal = document.getElementById("volumeTotalTempoInfusao-unit-select").value;
                                const unitTaxaInfusao = document.getElementById("taxaInfusaoTempoInfusao-unit-select").value;

                                if (isNaN(volumeTotal) || isNaN(taxaInfusao) || volumeTotal <= 0 || taxaInfusao <= 0) {
                                    throw new Error("Por favor, preencha todos os campos com valores numéricos válidos e maiores que zero.");
                                }

                                // Conversão para unidades base (mL e horas)
                                volumeTotal = convertToMl(volumeTotal, unitVolumeTotal);
                                taxaInfusao = convertTaxaInfusaoToMlPerHour(taxaInfusao, unitTaxaInfusao);

                                if (taxaInfusao === 0) {
                                    throw new Error("A Taxa de Infusão não pode ser zero.");
                                }

                                const tempoEmHoras = volumeTotal / taxaInfusao;
                                const tempoEmMinutos = tempoEmHoras * 60;

                                return {
                                    resultado: `Tempo de Infusão: ${tempoEmHoras.toFixed(2)} horas (${tempoEmMinutos.toFixed(2)} minutos)`,
                                    detalhes: [
                                        `Volume Total Convertido: ${volumeTotal.toFixed(2)} mL`,
                                        `Taxa de Infusão Convertida: ${taxaInfusao.toFixed(2)} mL/h`
                                    ]
                                };
                            },
                            referencias: []
                        },
                        "Gotejamento (gts/min)": {
                            name: "Gotejamento (gts/min)",
                            titulo: "Gotejamento (gts/min)",
                            fundamento: `Calcula a taxa de gotejamento em gotas por minuto (gts/min) para infusões intravenosas, essencial para a administração de fluidos e medicamentos quando se utiliza equipos de macrogotas ou microgotas. Garante que o volume total seja infundido no tempo prescrito.`,
                            formula: `Gotejamento (gts/min) = (Volume Total (mL) × Fator Gotejamento) / Tempo de Infusão (minutos)<br>Onde: Fator Gotejamento = 20 gts/mL (macrogotas) ou 60 gts/mL (microgotas)`,
                            exemploClinico: `<strong>🔸 Problema:</strong><br> Uma solução de 1000 mL deve ser infundida em 8 horas utilizando um equipo de macrogotas. Qual deve ser a taxa de gotejamento?<br><br><strong>🔹 Resolução:</strong><br><br><strong>1️⃣ Identificar os dados:</strong><br>• Volume Total = 1000 mL<br>• Tempo de Infusão = 8 horas (converter para minutos: 8 × 60 = 480 minutos)<br>• Tipo de Equipo = Macrogotas (Fator Gotejamento = 20 gts/mL)<br><br><strong>2️⃣ Aplicar a fórmula:</strong><br>• Gotejamento (gts/min) = (1000 mL × 20 gts/mL) / 480 minutos<br>• Gotejamento (gts/min) = 20000 / 480<br>• Gotejamento (gts/min) ≈ 41.67 gts/min ≈ 42 gts/min<br><br><hr><br><strong>✅ Resposta:</strong><br> O gotejamento deve ser de aproximadamente 42 gotas/min.`,
                            chamadaCalculadora: `Para calcular o gotejamento, informe o 'Volume Total', 'Tempo de Infusão' e o 'Tipo de Equipo'.`,
                            observacaoImportante: `Sempre arredonde o número de gotas/minuto para o número inteiro mais próximo, pois não é possível configurar frações de gotas. Mantenha a vigilância sobre o paciente e o gotejamento.`,
                            fields: [
                                { id: "volumeTotalGotejamento", label: "Volume Total da Solução:", type: "number", placeholder: "Ex: 1000", units: ["mL", "L"], defaultUnit: "mL", step: "0.01" },
                                { id: "tempoGotejamento", label: "Tempo de Infusão:", type: "number", placeholder: "Ex: 8", units: ["horas", "minutos"], defaultUnit: "horas", step: "0.01" },
                                { id: "tipoEquipo", label: "Tipo de Equipo:", type: "select", options: [{ value: "macro", text: "Macrogotas (20 gts/mL)" }, { value: "micro", text: "Microgotas (60 gts/mL)" }] }
                            ],
                            calculo: function() {
                                const volumeTotalInput = document.getElementById("volumeTotalGotejamento");
                                const tempoGotejamentoInput = document.getElementById("tempoGotejamento");
                                const tipoEquipo = document.getElementById("tipoEquipo").value;

                                let volumeTotal = parseFloat(volumeTotalInput.value);
                                let tempoInfusao = parseFloat(tempoGotejamentoInput.value);

                                const unitVolumeTotal = document.getElementById("volumeTotalGotejamento-unit-select").value;
                                const unitTempoInfusao = document.getElementById("tempoGotejamento-unit-select").value;

                                if (isNaN(volumeTotal) || isNaN(tempoInfusao) || volumeTotal <= 0 || tempoInfusao <= 0) {
                                    throw new Error("Por favor, preencha todos os campos com valores numéricos válidos e certifique-se que 'Volume Total da Solução' e 'Tempo de Infusão' são maiores que zero.");
                                }

                                // --- Conversão de Unidades ---
                                volumeTotal = convertToMl(volumeTotal, unitVolumeTotal); // Convert volume to mL
                                const tempoMinutos = convertTimeToMinutes(tempoInfusao, unitTempoInfusao); // Convert time to minutes

                                const fatorGotejamento = (tipoEquipo === "macro") ? 20 : 60;

                                if (tempoMinutos <= 0) {
                                    throw new Error("O Tempo de Infusão convertido é zero ou negativo. Verifique o valor de 'Tempo de Infusão'.");
                                }

                                const gotejamento = (volumeTotal * fatorGotejamento) / tempoMinutos;

                                if (gotejamento <= 0) {
                                    throw new Error("O Gotejamento calculado é zero ou negativo. Verifique os valores de entrada.");
                                }

                                return {
                                    resultado: `Gotejamento: ${Math.round(gotejamento)} gotas/min (${gotejamento.toFixed(2)} exato)`,
                                    detalhes: [
                                        `Volume Total da Solução Convertido: ${volumeTotal.toFixed(2)} mL`,
                                        `Tempo de Infusão Convertido: ${tempoMinutos.toFixed(2)} minutos`,
                                        `Tipo de Equipo: ${tipoEquipo === "macro" ? "Macrogotas" : "Microgotas"} (${fatorGotejamento} gts/mL)`
                                    ]
                                };
                            },
                            referencias: []
                        },
                        "Dose Administrada via Infusão (Drogas Vasoativas)": {
                            name: "Dose Administrada via Infusão (Drogas Vasoativas)",
                            titulo: "Dose Administrada via Infusão (Drogas Vasoativas)",
                            fundamento: `Calcula a taxa de infusão em mililitros por hora (mL/h) para medicamentos que requerem dosagem precisa por peso e tempo, como drogas vasoativas, sedativos e analgésicos. Isso permite a titulação da dose baseada na resposta do paciente.`,
                            formula: `Taxa de Infusão (mL/h) = (Dose (mcg/kg/min) &times; Peso (kg) &times; 60 min) / Concentração da Solução (mcg/mL)`,
                            exemploClinico: `<strong>🔸 Problema:</strong><br> Um paciente de 70 kg precisa de Norepinefrina a 0.1 mcg/kg/min. A solução foi preparada com 4 mg de Norepinefrina em 250 mL de SF 0.9%. Qual a taxa de infusão em mL/h?<br><br><strong>🔹 Resolução:</strong><br><br><strong>1️⃣ Identificar os dados:</strong><br>• Dose Desejada = 0.1 mcg/kg/min<br>• Peso = 70 kg<br>• Quantidade de Medicamento = 4 mg<br>• Volume da Solução = 250 mL<br><br><strong>2️⃣ Converter unidades para a base:</strong><br>• Quantidade de Medicamento = 4 mg = 4000 mcg<br>• Concentração da Solução = 4000 mcg / 250 mL = 16 mcg/mL<br><br><strong>3️⃣ Aplicar a fórmula:</strong><br>• Taxa de Infusão (mL/h) = (0.1 mcg/kg/min &times; 70 kg &times; 60 min) / 16 mcg/mL<br>• Taxa de Infusão (mL/h) = (7 &times; 60) / 16<br>• Taxa de Infusão (mL/h) = 420 / 16 = 26.25 mL/h<br><br><hr><br><strong>✅ Resposta:</strong><br> A taxa de infusão deve ser de aproximadamente 26.25 mL/h.`,
                            chamadaCalculadora: `Informe a 'Dose Desejada', o 'Peso do Paciente', a 'Quantidade de Medicamento no Frasco' e o 'Volume Total da Solução'.`,
                            observacaoImportante: `Certifique-se de que todas as unidades estejam consistentemente antes do cálculo. A concentração da solução é calculada a partir da quantidade de medicamento e do volume total da solução.`,
                            fields: [
                                { id: "doseDesejadaTIM", label: "Dose Desejada:", type: "number", placeholder: "Ex: 0.1", units: ["mcg/kg/min", "mg/kg/min", "mg/kg/h"], defaultUnit: "mcg/kg/min", step: "0.01" },
                                { id: "pesoPacienteTIM", label: "Peso do Paciente:", type: "number", placeholder: "Ex: 70", units: ["kg", "lb"], defaultUnit: "kg", step: "0.01" },
                                { id: "quantMedicamentoTIM", label: "Quantidade de Medicamento no Frasco:", type: "number", placeholder: "Ex: 4", units: ["mg", "g"], defaultUnit: "mg", step: "0.01" },
                                { id: "volumeSolucaoTIM", label: "Volume Total da Solução:", type: "number", placeholder: "Ex: 250", units: ["mL", "L"], defaultUnit: "mL", step: "0.01" }
                            ],
                            calculo: function() {
                                let doseDesejada = parseFloat(document.getElementById("doseDesejadaTIM").value);
                                let pesoPaciente = parseFloat(document.getElementById("pesoPacienteTIM").value);
                                let quantMedicamento = parseFloat(document.getElementById("quantMedicamentoTIM").value);
                                let volumeSolucao = parseFloat(document.getElementById("volumeSolucaoTIM").value);

                                const unitDoseDesejada = document.getElementById("doseDesejadaTIM-unit-select").value;
                                const unitPesoPaciente = document.getElementById("pesoPacienteTIM-unit-select").value;
                                const unitQuantMedicamento = document.getElementById("quantMedicamentoTIM-unit-select").value;
                                const unitVolumeSolucao = document.getElementById("volumeSolucaoTIM-unit-select").value;

                                if (isNaN(doseDesejada) || isNaN(pesoPaciente) || isNaN(quantMedicamento) || isNaN(volumeSolucao) ||
                                    doseDesejada <= 0 || pesoPaciente <= 0 || quantMedicamento <= 0 || volumeSolucao <= 0) {
                                    throw new Error("Por favor, preencha todos os campos com valores numéricos válidos e maiores que zero.");
                                }

                                // Conversão de unidades para base (mcg/kg/min, kg, mcg, mL)
                                doseDesejada = convertDosePerWeightPerTime(doseDesejada, unitDoseDesejada); // Converts to mcg/kg/min
                                pesoPaciente = convertToKg(pesoPaciente, unitPesoPaciente); // Converts to kg
                                quantMedicamento = convertToMcg(quantMedicamento, unitQuantMedicamento); // Converts to mcg
                                volumeSolucao = convertToMl(volumeSolucao, unitVolumeSolucao); // Converts to mL

                                if (volumeSolucao === 0) {
                                    throw new Error("O Volume Total da Solução não pode ser zero.");
                                }

                                const concentracaoSolucaoMcgPerMl = quantMedicamento / volumeSolucao; // mcg/mL

                                if (concentracaoSolucaoMcgPerMl === 0) {
                                    throw new Error("A Concentração da Solução é zero. Verifique a quantidade de medicamento e o volume da solução.");
                                }

                                // Taxa de Infusão (mL/h) = (Dose (mcg/kg/min) × Peso (kg) × 60 min/h) / Concentração da Solução (mcg/mL)
                                const taxaInfusaoMlH = (doseDesejada * pesoPaciente * 60) / concentracaoSolucaoMcgPerMl;

                                return {
                                    resultado: `Taxa de Infusão: ${taxaInfusaoMlH.toFixed(2)} mL/h`,
                                    detalhes: [
                                        `Dose Deseja Convertida: ${doseDesejada.toFixed(4)} mcg/kg/min`,
                                        `Peso do Paciente Convertido: ${pesoPaciente.toFixed(2)} kg`,
                                        `Quantidade de Medicamento Convertida: ${quantMedicamento.toFixed(2)} mcg`,
                                        `Volume da Solução Convertido: ${volumeSolucao.toFixed(2)} mL`,
                                        `Concentração da Solução: ${concentracaoSolucaoMcgPerMl.toFixed(4)} mcg/mL`
                                    ]
                                };
                            },
                            referencias: []
                        }
                    }
                },
                // 4. Avaliação Clínica e Farmacocinética (Estrutura Atualizada)
                "Avaliação Clínica e Farmacocinética": {
                    name: "Avaliação Clínica e Farmacocinética",
                    subcategories: {
                        "Função Renal": {
                            name: "Função Renal",
                            titulo: "Função Renal",
                            fundamento: "Avaliação necessária para ajuste de medicamentos eliminados por via renal.",
                            subSubCategories: { // Nested sub-subcategories
                                "Cockcroft-Gault": {
                                    name: "Cockcroft-Gault",
                                    titulo: "Fórmula de Cockcroft-Gault",
                                    fundamento: `Estimativa da depuração de creatinina (ClCr), amplamente usada para ajuste de antimicrobianos (como vancomicina e aminoglicosídeos). É crucial para adaptar a dosagem de medicamentos que são eliminados predominantemente pelos rins.`,
                                    formula: `ClCr (Homem) = (140 - idade) × peso (kg) / (72 × creatinina (mg/dL))<br>ClCr (Mulher) = resultado acima × 0.85`,
                                    exemploClinico: `<strong>🔸 Problema:</strong><br> Um homem de 70 anos pesa 70 kg e tem uma creatinina sérica de 1.2 mg/dL. Calcule a depuração de creatinina (ClCr).<br><br><strong>🔹 Resolução:</strong><br><br><strong>1️⃣ Identificar os dados:</strong><br>• Idade = 70 anos<br>• Peso = 70 kg<br>• Creatinina = 1.2 mg/dL<br>• Gênero = Masculino<br><br><strong>2️⃣ Aplicar a fórmula (Homem):</strong><br>• ClCr = (140 - 70) × 70 / (72 × 1.2)<br>• ClCr = 70 × 70 / 86.4<br>• ClCr = 4900 / 86.4 ≈ 56.74 mL/min<br><br><hr><br><strong>✅ Resposta:</strong><br> A depuração de creatinina estimada é de aproximadamente 56.74 mL/min.`,
                                    chamadaCalculadora: `Informe a idade, peso, creatinina sérica e gênero do paciente.`,
                                    observacaoImportante: `Em pacientes obesos (IMC > 30 kg/m²), o peso ideal ou peso ajustado pode ser utilizado para cálculos mais precisos, dependendo do fármaco. Para creatinina sérica < 1.0 mg/dL em idosos ou pacientes caquéticos, alguns recomendam arredondar para 1.0 mg/dL.`,
                                    fields: [
                                        { id: "idadeCG", label: "Idade:", type: "number", placeholder: "Anos", units: ["anos"], defaultUnit: "anos", step: "1" },
                                        { id: "pesoCG", label: "Peso:", type: "number", placeholder: "Ex: 70", units: ["kg", "lb"], defaultUnit: "kg", step: "0.1" },
                                        { id: "creatininaCG", label: "Creatinina Sérica:", type: "number", placeholder: "Ex: 1.2", units: ["mg/dL", "µmol/L"], defaultUnit: "mg/dL", step: "0.01" },
                                        { id: "generoCG", label: "Gênero:", type: "select", options: [{ value: "masculino", text: "Masculino" }, { value: "feminino", text: "Feminino" }] }
                                    ],
                                    calculo: function() {
                                        let idade = parseFloat(document.getElementById("idadeCG").value);
                                        let peso = parseFloat(document.getElementById("pesoCG").value);
                                        let creatinina = parseFloat(document.getElementById("creatininaCG").value);
                                        const genero = document.getElementById("generoCG").value;

                                        const unitPeso = document.getElementById("pesoCG-unit-select").value;
                                        const unitCreatinina = document.getElementById("creatininaCG-unit-select").value;

                                        if (isNaN(idade) || isNaN(peso) || isNaN(creatinina) ||
                                            idade <= 0 || peso <= 0 || creatinina <= 0) {
                                            throw new Error("Por favor, preencha todos os campos com valores numéricos válidos e maiores que zero.");
                                        }

                                        // Conversão de unidades
                                        peso = convertToKg(peso, unitPeso);
                                        creatinina = convertCreatinineToMgPerDl(creatinina, unitCreatinina);

                                        let clcr = ((140 - idade) * peso) / (72 * creatinina);

                                        if (genero === "feminino") {
                                            clcr *= 0.85;
                                        }

                                        // Classificação da função renal
                                        let classificacao;
                                        if (clcr >= 90) {
                                            classificacao = "Função renal normal";
                                        } else if (clcr >= 60) {
                                            classificacao = "Leve redução da função renal";
                                        } else if (clcr >= 30) {
                                            classificacao = "Redução moderada da função renal";
                                        } else if (clcr >= 15) {
                                            classificacao = "Redução grave da função renal";
                                        } else {
                                            classificacao = "Insuficiência renal";
                                        }

                                        return {
                                            resultado: `Depuração de Creatinina (ClCr): ${clcr.toFixed(2)} mL/min`,
                                            detalhes: [
                                                `Classificação: ${classificacao}`,
                                                `Peso Convertido: ${peso.toFixed(2)} kg`,
                                                `Creatinina Sérica Convertida: ${creatinina.toFixed(2)} mg/dL`,
                                                `Gênero: ${genero === "masculino" ? "Masculino" : "Feminino"}`,
                                                // Add a button to use this ClCr in the adjustment calculator
                                                `<button type="button" class="btn primary-btn mt-2" onclick="useCalculatedClCr(${clcr.toFixed(2)})">Usar este ClCr para Ajuste de ATB</button>`
                                            ]
                                        };
                                    },
                                    referencias: [
                                        "Cockcroft DW, Gault MH. Prediction of creatinine clearance from serum creatinine. Nephron. 1976."
                                    ]
                                },
                                "MDRD": {
                                    name: "MDRD",
                                    titulo: "Fórmula MDRD (Modification of Diet in Renal Disease)",
                                    fundamento: `Usada para estimar a Taxa de Filtração Glomerular (TFG), geralmente expressa em mL/min/1,73m². É mais comum em monitoramento de Doença Renal Crônica (DRC) do que em ajustes de dose precisos, pois a TFG estimada pode não refletir a depuração de medicamentos de forma tão direta quanto a ClCr.`,
                                    formula: `TFG (mL/min/1,73m²) = 175 × (creatinina sérica)<sup>-1.154</sup> × (idade)<sup>-0.203</sup> × (0.742 se mulher) × (1.212 se negro)`,
                                    exemploClinico: `<strong>🔸 Problema:</strong><br> Uma mulher negra de 60 anos tem creatinina sérica de 1.5 mg/dL. Calcule a TFG usando a fórmula MDRD.<br><br><strong>🔹 Resolução:</strong><br><br><strong>1️⃣ Identificar os dados:</strong><br>• Idade = 60 anos<br>• Creatinina = 1.5 mg/dL<br>• Gênero = Feminino<br>• Raça = Negra<br><br><strong>2️⃣ Aplicar a fórmula:</strong><br>• TFG = 175 × (1.5)<sup>-1.154</sup> × (60)<sup>-0.203</sup> × 0.742 × 1.212<br>• TFG = 175 × 0.609 × 0.380 × 0.742 × 1.212<br>• TFG ≈ 36.19 mL/min/1.73m²<br><br><hr><br><strong>✅ Resposta:</strong><br> A TFG estimada pela fórmula MDRD é de aproximadamente 36.19 mL/min/1.73m².`,
                                    chamadaCalculadora: `Informe a creatinina sérica, idade, gênero e raça do paciente.`,
                                    observacaoImportante: `A fórmula MDRD foi desenvolvida e validada primariamente para pacientes com doença renal crônica e pode subestimar a TFG em indivíduos saudáveis. A CKD-EPI é geralmente considerada mais precisa para uma gama mais ampla de pacientes.`,
                                    fields: [
                                        { id: "creatininaMDRD", label: "Creatinina Sérica:", type: "number", placeholder: "Ex: 1.5", units: ["mg/dL", "µmol/L"], defaultUnit: "mg/dL", step: "0.01" },
                                        { id: "idadeMDRD", label: "Idade:", type: "number", placeholder: "Anos", units: ["anos"], defaultUnit: "anos", step: "1" },
                                        { id: "generoMDRD", label: "Gênero:", type: "select", options: [{ value: "masculino", text: "Masculino" }, { value: "feminino", text: "Feminino" }] },
                                        { id: "racaMDRD", label: "Raça:", type: "select", options: [{ value: "nao_negro", text: "Não-negro" }, { value: "negro", text: "Negro" }] }
                                    ],
                                    calculo: function() {
                                        let creatinina = parseFloat(document.getElementById("creatininaMDRD").value);
                                        let idade = parseFloat(document.getElementById("idadeMDRD").value);
                                        const genero = document.getElementById("generoMDRD").value;
                                        const raca = document.getElementById("racaMDRD").value;

                                        const unitCreatinina = document.getElementById("creatininaMDRD-unit-select").value;

                                        if (isNaN(creatinina) || isNaN(idade) ||
                                            creatinina <= 0 || idade <= 0) {
                                            throw new Error("Por favor, preencha todos os campos com valores numéricos válidos e maiores que zero.");
                                        }

                                        // Convert creatinine to mg/dL if needed
                                        creatinina = convertCreatinineToMgPerDl(creatinina, unitCreatinina);

                                        let tfg = 175 * Math.pow(creatinina, -1.154) * Math.pow(idade, -0.203);

                                        if (genero === "feminino") {
                                            tfg *= 0.742;
                                        }
                                        if (raca === "negro") {
                                            tfg *= 1.212;
                                        }

                                        // Classificação da DRC
                                        let estagio;
                                        if (tfg >= 90) estagio = "Estágio 1: Normal ou alto";
                                        else if (tfg >= 60) estagio = "Estágio 2: Leve redução";
                                        else if (tfg >= 30) estagio = "Estágio 3: Redução moderada";
                                        else if (tfg >= 15) estagio = "Estágio 4: Redução grave";
                                        else estagio = "Estágio 5: Falência renal";

                                        return {
                                            resultado: `Taxa de Filtração Glomerular (TFG): ${tfg.toFixed(2)} mL/min/1.73m²`,
                                            detalhes: [
                                                `Estágio da DRC: ${estagio}`,
                                                `Creatinina Sérica Convertida: ${creatinina.toFixed(2)} mg/dL`,
                                                `Idade: ${idade} anos`,
                                                `Gênero: ${genero === "masculino" ? "Masculino" : "Feminino"}`,
                                                `Raça: ${raca === "negro" ? "Negro" : "Não-negro"}`
                                            ]
                                        };
                                    },
                                    referencias: [
                                        "Levey AS et al. A new equation to estimate glomerular filtration rate. Ann Intern Med. 2009."
                                    ]
                                },
                                "CKD-EPI (Apenas Informativo)": {
                                    name: "CKD-EPI (Apenas Informativo)",
                                    titulo: "Fórmula CKD-EPI (Apenas Informativo)",
                                    fundamento: `Considerada mais precisa que a MDRD para estimar a Taxa de Filtração Glomerular (TFG), especialmente em pacientes com TFG próxima ao normal. Contudo, ainda é pouco utilizada nas bulas de medicamentos para ajustes de dose diretos.`,
                                    formula: `Esta calculadora não implementa a fórmula CKD-EPI completa devido à sua complexidade e múltiplas equações dependendo de creatinina, gênero e raça. Ela é mencionada aqui para fins informativos sobre métodos de avaliação da função renal.`,
                                    exemploClinico: `Não há exemplo de cálculo disponível, pois a implementação completa da fórmula CKD-EPI requer uma série de equações condicionais.`,
                                    chamadaCalculadora: `Esta seção é apenas informativa sobre a fórmula CKD-EPI.`,
                                    observacaoImportante: `Para cálculos precisos de TFG via CKD-EPI, consulte calculadoras médicas especializadas ou recursos confiáveis que implementam todas as variáveis e equações complexas da fórmula. Sua principal aplicação é em monitoramento de Doença Renal Crônica.`,
                                    fields: [], // Sem campos de entrada para cálculo
                                    calculo: function() {
                                        throw new Error("Esta seção é apenas informativa e não realiza cálculos da fórmula CKD-EPI.");
                                    },
                                    referencias: [
                                        "Levey AS et al. A new equation to estimate glomerular filtration rate. Ann Intern Med. 2009."
                                    ]
                                },
                                "Ajuste de Dose por Função Renal": { // Título alterado
                                    name: "Ajuste de Dose de Antibióticos por Função Renal",
                                    titulo: "Ajuste de Dose de Antibióticos por Função Renal",
                                    fundamento: `A função renal impacta diretamente a eliminação de muitos medicamentos, especialmente antibióticos. Em pacientes com insuficiência renal, o acúmulo de fármacos pode levar à toxicidade. O ajuste da dose ou do intervalo entre as doses é crucial para garantir a eficácia terapêutica e a segurança do paciente. Esta calculadora utiliza dados específicos de antibióticos para sugerir ajustes baseados no clearance de creatinina (ClCr) e nas condições de diálise.`,
                                    formula: `O ajuste de dose é um processo complexo e dependente do fármaco. As estratégias comuns incluem:<br>
                                        <ul>
                                            <li><strong>Redução da Dose:</strong> Diminuir a quantidade de medicamento por administração.</li>
                                            <li><strong>Aumento do Intervalo:</strong> Manter a dose, mas aumentar o tempo entre as administrações.</li>
                                            <li><strong>Combinação:</strong> Reduzir a dose e aumentar o intervalo.</li>
                                            <li><strong>Considerações para Diálise:</strong> Doses específicas ou tempo de administração ajustado (pós-diálise).</li>
                                        </ul>
                                        A decisão é baseada no ClCr do paciente e nas características farmacocinéticas de cada droga.`,
                                    exemploClinico: `<strong>🔸 Exemplo: Ajuste de Vancomicina</strong><br>
                                        Paciente com ClCr de 35 mL/min (entre 10-50 mL/min), não em diálise, com peso de 70 kg.<br>
                                        Para **Vancomicina (500mg, frasco ampola)**, a posologia usual é "15-20mg/kg/dia, EV, 12/12h".<br><br>
                                        <strong>🔹 Resolução (via calculadora):</strong><br>
                                        Ao selecionar "Vancomicina" e "500mg, frasco ampola" e inserir o ClCr de 35 mL/min e peso de 70 kg, o resultado será:<br>
                                        "15-20mg/kg/dia, EV, com intervalos de 24h até 96h".<br><br>
                                        <strong>✅ Resposta:</strong><br>
                                        A calculadora indicará o ajuste de dose específico para Vancomicina na faixa de ClCr de 10-50 mL/min, com base nos dados fornecidos.`,
                                    chamadaCalculadora: `Informe o clearance de creatinina (ClCr), o peso do paciente e selecione o antibiótico e sua apresentação. Indique também se o paciente está em hemodiálise ou CAPD.`,
                                    observacaoImportante: `Esta calculadora fornece **orientações de ajuste de dose baseadas em dados específicos de antibióticos**. No entanto, **é IMPERATIVO consultar a bula do medicamento e/ou diretrizes clínicas atualizadas (como as publicadas pela ANVISA, Ministério do Saúde, Sociedade Brasileira de Nefrologia, KDIGO, ou protocolos institucionais) para determinar a dose exata e o intervalo de administração.** A automedicação ou ajuste de dose sem orientação profissional pode ser perigosa e levar a falha terapêutica ou toxicidade.`,
                                    fields: [
                                        { id: "clcrAjuste", label: "Clearance de Creatinina (ClCr):", type: "number", placeholder: "Ex: 45", units: ["mL/min"], defaultUnit: "mL/min", step: "0.1" },
                                        { id: "pesoAjusteATB", label: "Peso do Paciente (kg):", type: "number", placeholder: "Ex: 70", units: ["kg"], defaultUnit: "kg", step: "0.1" }, // Add weight field
                                        {
                                            id: "antibioticoSelect",
                                            label: "Selecione o Antibiótico:",
                                            type: "select",
                                            options: [{ value: "", text: "Selecione um Antibiótico" }] // Populated dynamically
                                        },
                                        {
                                            id: "apresentacaoSelect",
                                            label: "Selecione a Apresentação:",
                                            type: "select",
                                            options: [{ value: "", text: "Selecione a Apresentação" }] // Populated dynamically
                                        },
                                        { id: "hemodialise", label: "Paciente em Hemodiálise?", type: "checkbox" },
                                        { id: "capd", label: "Paciente em CAPD?", type: "checkbox" }
                                    ],
                                    calculo: function() {
                                        let clcr = parseFloat(document.getElementById("clcrAjuste").value);
                                        let peso = parseFloat(document.getElementById("pesoAjusteATB").value);
                                        const antibioticoNome = document.getElementById("antibioticoSelect").value;
                                        const apresentacaoDescricao = document.getElementById("apresentacaoSelect").value;
                                        const emHemodialise = document.getElementById("hemodialise").checked;
                                        const emCapd = document.getElementById("capd").checked;

                                        if (isNaN(clcr) || clcr < 0) {
                                            throw new Error("Por favor, preencha o campo 'Clearance de Creatinina' com um valor numérico válido e não negativo.");
                                        }
                                        if (isNaN(peso) || peso <= 0) {
                                            throw new Error("Por favor, preencha o campo 'Peso do Paciente' com um valor numérico válido e maior que zero.");
                                        }
                                        if (!antibioticoNome || antibioticoNome === "") {
                                            throw new Error("Por favor, selecione um Antibiótico.");
                                        }
                                        if (!apresentacaoDescricao || apresentacaoDescricao === "") {
                                            throw new Error("Por favor, selecione uma Apresentação.");
                                        }

                                        const resultadoAjuste = dadosAntibioticos.calcularDoseAjustada(
                                            antibioticoNome,
                                            apresentacaoDescricao,
                                            clcr,
                                            peso,
                                            emHemodialise,
                                            emCapd
                                        );

                                        if (!resultadoAjuste || !resultadoAjuste.doseAjustada) {
                                            throw new Error("Não foi possível encontrar o ajuste de dose para o antibiótico e apresentação selecionados nas condições fornecidas. Por favor, consulte a bula.");
                                        }

                                        let resultHtml = `<strong>Posologia Usual:</strong> ${resultadoAjuste.posologiaUsual}<br>`;
                                        resultHtml += `<strong>Ajuste de Dose Sugerido:</strong> ${resultadoAjuste.doseAjustada}`;

                                        if (resultadoAjuste.recomendacaoEspecial) {
                                            resultHtml += `<br> <em>(Recomendação Especial: ${resultadoAjuste.recomendacaoEspecial})</em>`;
                                        }

                                        return {
                                            resultado: resultHtml,
                                            detalhes: [
                                                `Antibiótico: ${resultadoAjuste.farmaco}`,
                                                `Apresentação: ${resultadoAjuste.apresentacao}`,
                                                `Clearance de Creatinina (ClCr): ${resultadoAjuste.clearance.toFixed(2)} mL/min (Faixa: ${resultadoAjuste.faixaClearance})`,
                                                `Peso do Paciente: ${peso.toFixed(2)} kg`,
                                                `Em Hemodiálise: ${emHemodialise ? 'Sim' : 'Não'}`,
                                                `Em CAPD: ${emCapd ? 'Sim' : 'Não'}`
                                            ]
                                        };
                                    },
                                    referencias: [
                                        "Dados internos da planilha 'A.A - monitorização da função renal Vs Dose de ATB'.",
                                        "Sempre consultar a bula do medicamento e diretrizes clínicas atualizadas para decisões de tratamento."
                                    ]
                                },
                                "Índice de Albuminúria / Creatinúria (UACR)": {
                                    name: "Índice de Albuminúria / Creatinúria (UACR)",
                                    titulo: "Índice de Albuminúria / Creatinúria (UACR)",
                                    fundamento: `O Índice de Albuminúria/Creatinúria (UACR) é um parâmetro crucial para a detecção precoce e monitoramento da doença renal crônica. A presença de albumina na urina (albuminúria) é um marcador de dano renal e risco cardiovascular aumentado. O UACR padroniza a excreção de albumina em relação à creatinina urinária, minimizando a influência da variação na diluição da urina.`,
                                    formula: `UACR = (Albumina urinária (mg/L)) / (Creatinina urinária (g/L))`,
                                    exemploClinico: `<strong>🔸 Problema:</strong><br> Um paciente tem albumina urinária de 50 mg/L e creatinina urinária de 0.8 g/L. Calcule o UACR e determine sua classificação.<br><br><strong>🔹 Resolução:</strong><br><br><strong>1️⃣ Identificar os dados:</strong><br>• Albumina urinária = 50 mg/L<br>• Creatinina urinária = 0.8 g/L<br><br><strong>2️⃣ Aplicar a fórmula:</strong><br>• UACR = 50 / 0.8 = 62.5 mg/g<br><br><strong>3️⃣ Classificar:</strong><br>• UACR de 62.5 mg/g se enquadra na faixa de Microalbuminúria (30–300 mg/g).<br><br><hr><br><strong>✅ Resposta:</strong><br> O Índice de Albuminúria/Creatinúria (UACR) é de 62.5 mg/g, indicando microalbuminúria.`,
                                    chamadaCalculadora: `Informe a albumina urinária e a creatinina urinária para calcular o UACR.`,
                                    observacaoImportante: `Valores de referência: Normal: <30 mg/g; Microalbuminúria: 30–300 mg/g; Proteinúria: >300 mg/g. A interpretação deve considerar fatores como exercício físico recente, febre, infecção do trato urinário e hipertensão descontrolada, que podem elevar temporariamente o UACR. Testes repetidos são recomendados para confirmar a albuminúria persistente.`,
                                    fields: [
                                        { id: "albuminaUACR", label: "Albumina urinária (mg/L):", type: "number", placeholder: "Ex: 50", units: ["mg/L"], defaultUnit: "mg/L", step: "0.01" },
                                        { id: "creatininaUACR", label: "Creatinina urinária (g/L):", type: "number", placeholder: "Ex: 0.8", units: ["g/L"], defaultUnit: "g/L", step: "0.01" }
                                    ],
                                    calculo: function() {
                                        let albumina = parseFloat(document.getElementById("albuminaUACR").value);
                                        let creatinina = parseFloat(document.getElementById("creatininaUACR").value);

                                        if (isNaN(albumina) || isNaN(creatinina) || albumina < 0 || creatinina <= 0) {
                                            throw new Error("Por favor, preencha todos os campos com valores numéricos válidos e positivos para creatinina urinária.");
                                        }

                                        const uacr = albumina / creatinina;

                                        let classificacao = "";
                                        if (uacr < 30) { classificacao = "Normal (<30 mg/g)"; }
                                        else if (uacr >= 30 && uacr <= 300) { classificacao = "Microalbuminúria (30–300 mg/g)"; }
                                        else { classificacao = "Proteinúria (>300 mg/g)"; }

                                        return {
                                            resultado: `UACR: ${uacr.toFixed(2)} mg/g<br>Classificação: ${classificacao}`,
                                            detalhes: [
                                                `Albumina urinária: ${albumina.toFixed(2)} mg/L`,
                                                `Creatinina urinária: ${creatinina.toFixed(2)} g/L`,
                                                `Recomendação: ${uacr > 30 ? "Repetir exame para confirmar" : "Resultado normal"}`
                                            ]
                                        };
                                    },
                                    referencias: [
                                        "KDIGO 2012 Clinical Practice Guideline for the Evaluation and Management of Chronic Kidney Disease."
                                    ]
                                }
                            }
                        },
                        "Função Hepática": {
                            name: "Função Hepática",
                            titulo: "Função Hepática",
                            fundamento: "Avaliação da capacidade metabólica do fígado para ajuste de medicamentos hepatometabolizados.",
                            subSubCategories: {
                                "Escore de Child-Pugh": {
                                    name: "Escore de Child-Pugh",
                                    titulo: "Escore de Child-Pugh",
                                    fundamento: `Classifica a gravidade da doença hepática crônica (especialmente cirrose) em classes A, B ou C. Fundamental para prever risco cirúrgico e ajustar doses de medicamentos como anticoagulantes, antidepressivos e analgésicos.`,
                                    formula: `Pontos atribuídos (1-3) para cada parâmetro:<br>
                                    • Bilirrubina total<br>
                                    • Albumina sérica<br>
                                    • INR (Tempo de Protrombina)<br>
                                    • Ascite<br>
                                    • Encefalopatia hepática<br><br>
                                    <strong>Classificação:</strong><br>
                                    • Classe A: 5-6 pontos<br>
                                    • Classe B: 7-9 pontos<br>
                                    • Classe C: 10-15 pontos`,
                                    exemploClinico: `<strong>🔸 Caso Clínico:</strong><br> Paciente com cirrose alcoólica apresenta:<br>
                                    • Bilirrubina: 3.5 mg/dL (3 pontos)<br>
                                    • Albumina: 2.5 g/dL (2 pontos)<br>
                                    • INR: 2.0 (2 pontos)<<br>
                                    • Ascite moderada (3 pontos)<br>
                                    • Encefalopatia grau II (2 pontos)<br><br>
                                    <strong>🔹 Cálculo:</strong><br>
                                    Total = 3 + 2 + 2 + 3 + 2 = 12 pontos (Classe C)<br><br>
                                    <strong>✅ Interpretação:</strong><br>
                                    Doença hepática descompensada. Risco elevado de complicações. Ajustar doses de todos os medicamentos hepatometabolizados.`,
                                    chamadaCalculadora: `Selecione os parâmetros do paciente para calcular o escore.`,
                                    observacaoImportante: `Pacientes Child-Pugh C geralmente requerem redução de 50% nas doses iniciais de medicamentos hepatometabolizados. Monitorar rigorosamente.`,
                                    fields: [
                                        { id: "bilirrubinaCP", label: "Bilirrubina Total (mg/dL):", type: "number", placeholder: "Ex: 1.5", step: "0.1" },
                                        { id: "albuminaCP", label: "Albumina (g/dL):", type: "number", placeholder: "Ex: 3.0", step: "0.1" },
                                        { id: "inrCP", label: "INR:", type: "number", placeholder: "Ex: 1.2", step: "0.01" },
                                        { id: "asciteCP", label: "Ascite:", type: "select", options: [
                                            { value: "ausente", text: "Ausente" },
                                            { value: "leve", text: "Leve" },
                                            { value: "moderada", text: "Moderada/Tensa" }
                                        ]},
                                        { id: "encefalopatiaCP", label: "Encefalopatia Hepática:", type: "select", options: [
                                            { value: "ausente", text: "Ausente" },
                                            { value: "grau_i_ii", text: "Grau I-II (Leve a Moderada)" },
                                            { value: "grau_iii_iv", text: "Grau III-IV (Grave)" }
                                        ]}
                                    ],
                                    calculo: function() {
                                        let bilirrubina = parseFloat(document.getElementById("bilirrubinaCP").value);
                                        let albumina = parseFloat(document.getElementById("albuminaCP").value);
                                        let inr = parseFloat(document.getElementById("inrCP").value);
                                        const ascite = document.getElementById("asciteCP").value;
                                        const encefalopatia = document.getElementById("encefalopatiaCP").value;

                                        if (isNaN(bilirrubina) || isNaN(albumina) || isNaN(inr) ||
                                            bilirrubina < 0 || albumina < 0 || inr < 0) {
                                            throw new Error("Por favor, preencha os campos numéricos com valores válidos e não negativos.");
                                        }

                                        let score = 0;
                                        let detalhes = [];

                                        // Bilirrubina Total
                                        if (bilirrubina < 2) { score += 1; detalhes.push(`Bilirrubina Total (< 2 mg/dL): 1 ponto`); }
                                        else if (bilirrubina >= 2 && bilirrubina <= 3) { score += 2; detalhes.push(`Bilirrubina Total (2-3 mg/dL): 2 pontos`); }
                                        else { score += 3; detalhes.push(`Bilirrubina Total (> 3 mg/dL): 3 pontos`); }

                                        // Albumina
                                        if (albumina > 3.5) { score += 1; detalhes.push(`Albumina (> 3.5 g/dL): 1 ponto`); }
                                        else if (albumina >= 2.8 && albumina <= 3.5) { score += 2; detalhes.push(`Albumina (2.8-3.5 g/dL): 2 pontos`); }
                                        else { score += 3; detalhes.push(`Albumina (< 2.8 g/dL): 3 pontos`); }

                                        // INR
                                        if (inr < 1.7) { score += 1; detalhes.push(`INR (< 1.7): 1 ponto`); }
                                        else if (inr >= 1.7 && inr <= 2.3) { score += 2; detalhes.push(`INR (1.7-2.3): 2 pontos`); }
                                        else { score += 3; detalhes.push(`INR (> 2.3): 3 pontos`); }

                                        // Ascite
                                        if (ascite === "ausente") { score += 1; detalhes.push(`Ascite: Ausente (1 ponto)`); }
                                        else if (ascite === "leve") { score += 2; detalhes.push(`Ascite: Leve (2 pontos)`); }
                                        else { score += 3; detalhes.push(`Ascite: Moderada/Tensa (3 pontos)`); }

                                        // Encefalopatia Hepática
                                        if (encefalopatia === "ausente") { score += 1; detalhes.push(`Encefalopatia Hepática: Ausente (1 ponto)`); }
                                        else if (encefalopatia === "grau_i_ii") { score += 2; detalhes.push(`Encefalopatia Hepática: Grau I-II (2 pontos)`); }
                                        else { score += 3; detalhes.push(`Encefalopatia Hepática: Grau III-IV (3 pontos)`); }

                                        let classificacao = "";
                                        if (score >= 5 && score <= 6) { classificacao = "Classe A (5-6 pontos)"; }
                                        else if (score >= 7 && score <= 9) { classificacao = "Classe B (7-9 pontos)"; }
                                        else { classificacao = "Classe C (10-15 pontos)"; }

                                        return {
                                            resultado: `Escore Child-Pugh: ${score} pontos<br>Classificação: ${classificacao}`,
                                            detalhes: detalhes
                                        };
                                    },
                                    referencias: [
                                        "Pugh RNH, Murray-Lyon IM, Dawson JL, Pietroni MF, Williams R. Transection of the oesophagus for bleeding oesophageal varices. Br J Surg. 1973."
                                    ]
                                }
                            }
                        }
                    }
                },
                // 5. Nova Categoria: Conversões de Unidades
                "Conversões de Unidades": {
                    name: "Conversões de Unidades",
                    subcategories: {
                        "Massa": {
                            name: "Massa",
                            titulo: "Conversão de Unidades de Massa",
                            fundamento: `Converta facilmente entre diferentes unidades de massa, como microgramas (mcg), miligramas (mg), gramas (g) e quilogramas (kg).`,
                            formula: `Utiliza fatores de conversão padrão.`,
                            exemploClinico: `<strong>🔸 Exemplo:</strong> Converter 1500 mg para gramas.<br><strong>🔹 Resolução:</strong> 1500 mg / 1000 = 1.5 g.<br><br><hr><br><strong>✅ Resposta:</strong> 1.5 g.`,
                            chamadaCalculadora: `Informe o valor, a unidade de origem e a unidade de destino.`,
                            observacaoImportante: `Certifique-se de que a unidade de origem e a de destino são válidas para massa.`,
                            fields: [
                                { id: "valorMassa", label: "Valor:", type: "number", placeholder: "Ex: 1000", step: "0.01" },
                                { id: "unitFromMassa", label: "Unidade de Origem:", type: "select", options: [{ value: "mcg", text: "mcg" }, { value: "mg", text: "mg" }, { value: "g", text: "g" }, { value: "kg", text: "kg" }] },
                                { id: "unitToMassa", label: "Unidade de Destino:", type: "select", options: [{ value: "mcg", text: "mcg" }, { value: "mg", text: "mg" }, { value: "g", text: "g" }, { value: "kg", text: "kg" }] }
                            ],
                            calculo: function() {
                                let value = parseFloat(document.getElementById("valorMassa").value);
                                const unitFrom = document.getElementById("unitFromMassa").value;
                                const unitTo = document.getElementById("unitToMassa").value;

                                if (isNaN(value) || value < 0) {
                                    throw new Error("Por favor, insira um valor numérico válido e não negativo.");
                                }

                                const result = convertMass(value, unitFrom, unitTo);

                                return {
                                    resultado: `${value} ${unitFrom} = ${result.toFixed(4)} ${unitTo}`,
                                    detalhes: [`Valor original: ${value} ${unitFrom}`, `Valor convertido: ${result.toFixed(4)} ${unitTo}`]
                                };
                            }
                        },
                        "Volume": {
                            name: "Volume",
                            titulo: "Conversão de Unidades de Volume",
                            fundamento: `Converta facilmente entre diferentes unidades de volume, como mililitros (mL) e litros (L).`,
                            formula: `Utiliza fatores de conversão padrão.`,
                            exemploClinico: `<strong>🔸 Exemplo:</strong> Converter 2.5 L para mL.<br><strong>🔹 Resolução:</strong> 2.5 L * 1000 = 2500 mL.<br><br><hr><br><strong>✅ Resposta:</strong> 2500 mL.`,
                            chamadaCalculadora: `Informe o valor, a unidade de origem e a unidade de destino.`,
                            observacaoImportante: `Certifique-se de que a unidade de origem e a de destino são válidas para volume.`,
                            fields: [
                                { id: "valorVolume", label: "Valor:", type: "number", placeholder: "Ex: 100", step: "0.01" },
                                { id: "unitFromVolume", label: "Unidade de Origem:", type: "select", options: [{ value: "mL", text: "mL" }, { value: "L", text: "L" }] },
                                { id: "unitToVolume", label: "Unidade de Destino:", type: "select", options: [{ value: "mL", text: "mL" }, { value: "L", text: "L" }] }
                            ],
                            calculo: function() {
                                let value = parseFloat(document.getElementById("valorVolume").value);
                                const unitFrom = document.getElementById("unitFromVolume").value;
                                const unitTo = document.getElementById("unitToVolume").value;

                                if (isNaN(value) || value < 0) {
                                    throw new Error("Por favor, insira um valor numérico válido e não negativo.");
                                }

                                const result = convertVolume(value, unitFrom, unitTo);

                                return {
                                    resultado: `${value} ${unitFrom} = ${result.toFixed(4)} ${unitTo}`,
                                    detalhes: [`Valor original: ${value} ${unitFrom}`, `Valor convertido: ${result.toFixed(4)} ${unitTo}`]
                                };
                            }
                        },
                        "Concentração": {
                            name: "Concentração",
                            titulo: "Conversão de Unidades de Concentração",
                            fundamento: `Converta facilmente entre diferentes unidades de concentração, como microgramas por mililitro (mcg/mL), miligramas por mililitro (mg/mL), gramas por mililitro (g/mL) e porcentagem (% m/v).`,
                            formula: `Utiliza fatores de conversão padrão, considerando 1% m/v = 10 mg/mL.`,
                            exemploClinico: `<strong>🔸 Exemplo:</strong> Converter 0.5 g/mL para % m/v.<br><strong>🔹 Resolução:</strong> 0.5 g/mL * 1000 (para mg) / 10 (para %) = 50 %.<br><br><hr><br><strong>✅ Resposta:</strong> 50 % m/v.`,
                            chamadaCalculadora: `Informe o valor, a unidade de origem e a unidade de destino.`,
                            observacaoImportante: `A conversão de porcentagem assume % m/v (massa/volume) onde 1% = 10 mg/mL.`,
                            fields: [
                                { id: "valorConcentracao", label: "Valor:", type: "number", placeholder: "Ex: 10", step: "0.01" },
                                { id: "unitFromConcentracao", label: "Unidade de Origem:", type: "select", options: [{ value: "mcg/mL", text: "mcg/mL" }, { value: "mg/mL", text: "mg/mL" }, { value: "g/mL", text: "g/mL" }, { value: "%", text: "% (m/v)" }] },
                                { id: "unitToConcentracao", label: "Unidade de Destino:", type: "select", options: [{ value: "mcg/mL", text: "mcg/mL" }, { value: "mg/mL", text: "mg/mL" }, { value: "g/mL", text: "g/mL" }, { value: "%", text: "% (m/v)" }] }
                            ],
                            calculo: function() {
                                let value = parseFloat(document.getElementById("valorConcentracao").value);
                                const unitFrom = document.getElementById("unitFromConcentracao").value;
                                const unitTo = document.getElementById("unitToConcentracao").value;

                                if (isNaN(value) || value < 0) {
                                    throw new Error("Por favor, insira um valor numérico válido e não negativo.");
                                }

                                const result = convertConcentration(value, unitFrom, unitTo);

                                return {
                                    resultado: `${value} ${unitFrom} = ${result.toFixed(4)} ${unitTo}`,
                                    detalhes: [`Valor original: ${value} ${unitFrom}`, `Valor convertido: ${result.toFixed(4)} ${unitTo}`]
                                };
                            }
                        },
                        "Taxa de Infusão": {
                            name: "Taxa de Infusão",
                            titulo: "Conversão de Unidades de Taxa de Infusão",
                            fundamento: `Converta facilmente entre diferentes unidades de taxa de infusão, como mililitros por hora (mL/h), mililitros por minuto (mL/min) e litros por hora (L/h).`,
                            formula: `Utiliza fatores de conversão padrão.`,
                            exemploClinico: `<strong>🔸 Exemplo:</strong> Converter 100 mL/min para mL/h.<br><strong>🔹 Resolução:</strong> 100 mL/min * 60 = 6000 mL/h.<br><br><hr><br><strong>✅ Resposta:</strong> 6000 mL/h.`,
                            chamadaCalculadora: `Informe o valor, a unidade de origem e a unidade de destino.`,
                            observacaoImportante: `Certifique-se de que a unidade de origem e a de destino são válidas para taxa de infusão.`,
                            fields: [
                                { id: "valorTaxaInfusao", label: "Valor:", type: "number", placeholder: "Ex: 50", step: "0.01" },
                                { id: "unitFromTaxaInfusao", label: "Unidade de Origem:", type: "select", options: [{ value: "mL/min", text: "mL/min" }, { value: "mL/h", text: "mL/h" }, { value: "L/h", text: "L/h" }] },
                                { id: "unitToTaxaInfusao", label: "Unidade de Destino:", type: "select", options: [{ value: "mL/min", text: "mL/min" }, { value: "mL/h", text: "mL/h" }, { value: "L/h", text: "L/h" }] }
                            ],
                            calculo: function() {
                                let value = parseFloat(document.getElementById("valorTaxaInfusao").value);
                                const unitFrom = document.getElementById("unitFromTaxaInfusao").value;
                                const unitTo = document.getElementById("unitToTaxaInfusao").value;

                                if (isNaN(value) || value < 0) {
                                    throw new Error("Por favor, insira um valor numérico válido e não negativo.");
                                }

                                const result = convertInfusionRate(value, unitFrom, unitTo);

                                return {
                                    resultado: `${value} ${unitFrom} = ${result.toFixed(4)} ${unitTo}`,
                                    detalhes: [`Valor original: ${value} ${unitFrom}`, `Valor convertido: ${result.toFixed(4)} ${unitTo}`]
                                };
                            }
                        },
                        "Tempo": {
                            name: "Tempo",
                            titulo: "Conversão de Unidades de Tempo",
                            fundamento: `Converta facilmente entre diferentes unidades de tempo, como minutos e horas.`,
                            formula: `Utiliza fatores de conversão padrão.`,
                            exemploClinico: `<strong>🔸 Exemplo:</strong> Converter 120 minutos para horas.<br><strong>🔹 Resolução:</strong> 120 minutos / 60 = 2 horas.<br><br><hr><br><strong>✅ Resposta:</strong> 2 horas.`,
                            chamadaCalculadora: `Informe o valor, a unidade de origem e a unidade de destino.`,
                            observacaoImportante: `Certifique-se de que a unidade de origem e a de destino são válidas para tempo.`,
                            fields: [
                                { id: "valorTempo", label: "Valor:", type: "number", placeholder: "Ex: 60", step: "0.01" },
                                { id: "unitFromTempo", label: "Unidade de Origem:", type: "select", options: [{ value: "minutos", text: "minutos" }, { value: "horas", text: "horas" }] },
                                { id: "unitToTempo", label: "Unidade de Destino:", type: "select", options: [{ value: "minutos", text: "minutos" }, { value: "horas", text: "horas" }] }
                            ],
                            calculo: function() {
                                let value = parseFloat(document.getElementById("valorTempo").value);
                                const unitFrom = document.getElementById("unitFromTempo").value;
                                const unitTo = document.getElementById("unitToTempo").value;

                                if (isNaN(value) || value < 0) {
                                    throw new Error("Por favor, insira um valor numérico válido e não negativo.");
                                }

                                const result = convertTime(value, unitFrom, unitTo);

                                return {
                                    resultado: `${value} ${unitFrom} = ${result.toFixed(4)} ${unitTo}`,
                                    detalhes: [`Valor original: ${value} ${unitFrom}`, `Valor convertido: ${result.toFixed(4)} ${unitTo}`]
                                };
                            }
                        }
                    }
                }
            };

            // Obtém referências aos elementos HTML da calculadora
            const calculationTypeSelect = document.getElementById('calculationType');
            const dynamicFieldsDiv = document.getElementById('dynamicFields');
            const calculateButton = document.getElementById('calculateButton');
            const resultsDiv = document.getElementById('results');
            const resultText = document.getElementById('resultText'); // Para exibir o texto do resultado

            // Função para popular o dropdown de tipos de cálculo
            function populateCalculationTypes() {
                calculationTypeSelect.innerHTML = '<option value="">Selecione um tipo de cálculo</option>';
                for (const key in calculationConfigs) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = calculationConfigs[key].name || key;
                    calculationTypeSelect.appendChild(option);
                }
            }

            // Função para gerar os campos dinâmicos com base no tipo de cálculo e subcategoria selecionados
            function generateDynamicFields(config) {
                dynamicFieldsDiv.innerHTML = ''; // Limpa os campos existentes
                resultsDiv.classList.add('hidden'); // Esconde a área de resultados
                resultText.textContent = ''; // Limpa o texto do resultado

                if (!config) {
                    return; // Não faz nada se não houver configuração
                }

                // Cria o dropdown de subcategorias
                const subcategoryLabel = document.createElement('label');
                subcategoryLabel.setAttribute('for', 'subcategory');
                subcategoryLabel.textContent = 'Subcategoria:';
                dynamicFieldsDiv.appendChild(subcategoryLabel);

                const subcategorySelect = document.createElement('select');
                subcategorySelect.id = 'subcategory';
                subcategorySelect.className = 'w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500';
                dynamicFieldsDiv.appendChild(subcategorySelect);

                // Adiciona a opção padrão "Selecione"
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Selecione uma subcategoria';
                subcategorySelect.appendChild(defaultOption);

                // Popula o dropdown com as subcategorias
                for (const key in config.subcategories) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = config.subcategories[key].name || key; // Use 'name' if available, otherwise key
                    subcategorySelect.appendChild(option);
                }

                // Add a div to hold the content generated by renderCategoryContent
                const inputFieldsContainer = document.createElement('div');
                inputFieldsContainer.id = 'inputFieldsContainer';
                dynamicFieldsDiv.appendChild(inputFieldsContainer);

                // Adiciona um ouvinte de evento para o dropdown de subcategorias
                subcategorySelect.addEventListener('change', () => {
                    const selectedSubcategoryKey = subcategorySelect.value;
                    const subcategoryConfig = config.subcategories[selectedSubcategoryKey];
                    renderCategoryContent(subcategoryConfig); // Call the new function
                });
            }

            // Function to render content based on selected category/subcategory
            function renderCategoryContent(config) {
                const inputFieldsContainer = document.getElementById('inputFieldsContainer');
                inputFieldsContainer.innerHTML = ''; // Clear previous content

                resultsDiv.classList.add('hidden'); // Hide results area
                resultText.textContent = ''; // Clear result text

                if (!config) {
                    return;
                }

                // If there are sub-subcategories, render the sub-subcategory select
                if (config.subSubCategories) {
                    const subSubcategoryLabel = document.createElement('label');
                    subSubcategoryLabel.setAttribute('for', 'subSubcategory');
                    subSubcategoryLabel.textContent = 'Sub-subcategoria:';
                    inputFieldsContainer.appendChild(subSubcategoryLabel);

                    const subSubcategorySelect = document.createElement('select');
                    subSubcategorySelect.id = 'subSubcategory';
                    subSubcategorySelect.className = 'w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500';
                    inputFieldsContainer.appendChild(subSubcategorySelect);

                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Selecione uma sub-subcategoria';
                    subSubcategorySelect.appendChild(defaultOption);

                    for (const key in config.subSubCategories) {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = config.subSubCategories[key].name || key;
                        subSubcategorySelect.appendChild(option);
                    }

                    subSubcategorySelect.addEventListener('change', () => {
                        const selectedSubSubcategoryKey = subSubcategorySelect.value;
                        const subSubcategoryConfig = config.subSubCategories[selectedSubSubcategoryKey];
                        renderInputFields(subSubcategoryConfig); // Call renderInputFields for the selected sub-sub

                        // Special handling to populate antibiotic dropdown when "Ajuste de Dose de Antibióticos" is selected
                        if (selectedSubSubcategoryKey === "Ajuste de Dose por Função Renal") {
                            const antibioticSelect = document.getElementById('antibioticoSelect');
                            if (antibioticSelect) {
                                antibioticSelect.innerHTML = '<option value="">Selecione um Antibiótico</option>';
                                dadosAntibioticos.antibioticos.forEach(ab => {
                                    const option = document.createElement('option');
                                    option.value = ab.farmaco;
                                    option.textContent = ab.farmaco;
                                    antibioticSelect.appendChild(option);
                                });
                            }
                        }
                    });
                } else {
                    // If no sub-subcategories, render input fields directly
                    renderInputFields(config);
                }
            }

            // Function to render actual input fields and info for a leaf-level config
            function renderInputFields(configToRender) {
                const inputFieldsContainer = document.getElementById('inputFieldsContainer');

                // Clear only the *input fields specific content*, not the sub-subcategory select if it exists
                // This requires a separate container for the actual input fields
                let actualInputFieldsDiv = document.getElementById('actualInputFieldsDiv');
                if (!actualInputFieldsDiv) {
                    actualInputFieldsDiv = document.createElement('div');
                    actualInputFieldsDiv.id = 'actualInputFieldsDiv';
                    inputFieldsContainer.appendChild(actualInputFieldsDiv);
                }
                actualInputFieldsDiv.innerHTML = ''; // Clear only the input fields

                resultsDiv.classList.add('hidden'); // Hide results area
                resultText.textContent = ''; // Clear result text

                if (!configToRender) {
                    return;
                }

                // Display detailed information for the subcategory
                let infoHtml = '';
                if (configToRender.fundamento) {
                    infoHtml += `<p class="text-gray-700 mb-2"><strong>Fundamento:</strong> ${configToRender.fundamento}</p>`;
                }
                if (configToRender.formula) {
                    infoHtml += `<p class="text-gray-700 mb-2"><strong>Fórmula:</strong> ${configToRender.formula}</p>`;
                }
                if (configToRender.exemploClinico) {
                    infoHtml += `<div class="bg-blue-50 border border-blue-200 text-blue-800 p-4 rounded-lg mb-4 text-left">
                                    <h4 class="font-semibold text-blue-900 mb-2">Exemplo Clínico:</h4>
                                    <p>${configToRender.exemploClinico}</p>
                                 </div>`;
                }
                if (configToRender.chamadaCalculadora) {
                    infoHtml += `<p class="text-gray-700 mb-4"><strong>Instruções:</strong> ${configToRender.chamadaCalculadora}</p>`;
                }
                if (configToRender.observacaoImportante) {
                    infoHtml += `<div class="bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg mb-4 text-left">
                                    <h4 class="font-semibold text-yellow-900 mb-2">Observação Importante:</h4>
                                    <p>${configToRender.observacaoImportante}</p>
                                 </div>`;
                }
                if (infoHtml) {
                    const infoDiv = document.createElement('div');
                    infoDiv.innerHTML = infoHtml;
                    actualInputFieldsDiv.appendChild(infoDiv); // Append to the new container
                }

                // Determine the variable to calculate for C1V1=C2V2
                const variableToCalculateSelect = document.getElementById('variableToCalculate');
                const selectedVariable = variableToCalculateSelect ? variableToCalculateSelect.value : null;

                // Add input fields for the selected subcategory
                configToRender.fields.forEach(field => {
                    const div = document.createElement('div');
                    div.className = 'mb-4 form-group';

                    // Check if the field should be hidden for C1V1=C2V2
                    if (selectedVariable && field.hideFor && field.hideFor.includes(selectedVariable)) {
                        div.classList.add('hidden');
                    }

                    const label = document.createElement('label');
                    label.setAttribute('for', field.id);
                    label.textContent = field.label;
                    div.appendChild(label);

                    if (field.type === 'select' && field.options) {
                        const select = document.createElement('select');
                        select.id = field.id;
                        select.className = 'w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500';

                        field.options.forEach(optionData => {
                            const option = document.createElement('option');
                            option.value = optionData.value;
                            option.textContent = optionData.text;
                            select.appendChild(option);
                        });

                        div.appendChild(select);

                        // Special handling for antibiotic selection to populate presentation dropdown
                        if (field.id === 'antibioticoSelect') {
                            select.addEventListener('change', () => {
                                populatePresentationSelect(select.value);
                            });
                        }
                        // Special handling for C1V1=C2V2 variable selection
                        if (field.id === 'variableToCalculate') {
                            select.addEventListener('change', () => {
                                renderInputFields(configToRender); // Re-render fields when this changes
                            });
                        }

                    } else if (field.type === 'checkbox') {
                        const checkboxContainer = document.createElement('div');
                        checkboxContainer.className = 'flex items-center mt-2';
                        const input = document.createElement('input');
                        input.type = 'checkbox';
                        input.id = field.id;
                        input.className = 'mr-2 h-5 w-5 text-green-600 rounded focus:ring-green-500';
                        const checkboxLabel = document.createElement('label');
                        checkboxLabel.setAttribute('for', field.id);
                        checkboxLabel.textContent = field.label;
                        checkboxLabel.className = 'text-gray-700';
                        checkboxContainer.appendChild(input);
                        checkboxContainer.appendChild(checkboxLabel);
                        div.appendChild(checkboxContainer);

                    } else { // type is 'number' or 'text'
                        const inputGroup = document.createElement('div');
                        inputGroup.className = 'flex items-center space-x-2'; // Use flex for input and unit select

                        const input = document.createElement('input');
                        input.type = field.type;
                        input.id = field.id;
                        input.className = 'flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500';
                        input.placeholder = field.placeholder;
                        if (field.step) {
                            input.step = field.step;
                        } else {
                            input.step = "0.01"; // Default step for numbers
                        }
                        inputGroup.appendChild(input);

                        if (field.units && field.units.length > 0) {
                            const unitSelect = document.createElement('select');
                            unitSelect.id = `${field.id}-unit-select`;
                            unitSelect.className = 'p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500';

                            field.units.forEach(unit => {
                                const option = document.createElement('option');
                                option.value = unit;
                                option.textContent = unit;
                                if (unit === field.defaultUnit) {
                                    option.selected = true;
                                }
                                unitSelect.appendChild(option);
                            });
                            inputGroup.appendChild(unitSelect);
                        }
                        div.appendChild(inputGroup);
                    }

                    actualInputFieldsDiv.appendChild(div); // Append to the new container
                });
            }

            // Function to populate presentation dropdown based on selected antibiotic
            function populatePresentationSelect(antibioticName) {
                const presentationSelect = document.getElementById('apresentacaoSelect');
                if (!presentationSelect) return;

                presentationSelect.innerHTML = '<option value="">Selecione uma Apresentação</option>'; // Clear and add default

                const antibiotic = dadosAntibioticos.buscarAntibiotico(antibioticName);
                if (antibiotic && antibiotic.apresentacoes) {
                    antibiotic.apresentacoes.forEach(ap => {
                        const option = document.createElement('option');
                        option.value = ap.descricao;
                        option.textContent = ap.descricao;
                        presentationSelect.appendChild(option);
                    });
                }
            }

            // Global function to use calculated ClCr in the adjustment calculator
            window.useCalculatedClCr = function(clcrValue) {
                // Set the main category to "Avaliação Clínica e Farmacocinética"
                calculationTypeSelect.value = "Avaliação Clínica e Farmacocinética";
                calculationTypeSelect.dispatchEvent(new Event('change')); // Trigger change to populate subcategories

                // Wait for subcategories to be populated, then select "Função Renal"
                setTimeout(() => {
                    const subcategorySelect = document.getElementById('subcategory');
                    if (subcategorySelect) {
                        subcategorySelect.value = "Função Renal";
                        subcategorySelect.dispatchEvent(new Event('change')); // Trigger change to populate sub-subcategories

                        // Wait for sub-subcategories to be populated, then select "Ajuste de Dose por Função Renal"
                        setTimeout(() => {
                            const subSubcategorySelect = document.getElementById('subSubcategory');
                            if (subSubcategorySelect) {
                                subSubcategorySelect.value = "Ajuste de Dose por Função Renal";
                                subSubcategorySelect.dispatchEvent(new Event('change')); // Trigger change to render fields

                                // Finally, set the ClCr value
                                setTimeout(() => {
                                    const clcrInput = document.getElementById('clcrAjuste');
                                    if (clcrInput) {
                                        clcrInput.value = clcrValue;
                                    }
                                }, 50); // Small delay to ensure field is rendered
                            }
                        }, 50); // Small delay to ensure subcategories are populated
                    }
                }, 50); // Small delay to ensure main category change is processed
            };


            // Evento que dispara quando o tipo de cálculo é selecionado
            calculationTypeSelect.addEventListener('change', () => {
                const selectedType = calculationTypeSelect.value;
                generateDynamicFields(calculationConfigs[selectedType]);
            });

            // Evento que dispara quando o botão de calcular é clicado
            calculateButton.addEventListener('click', () => {
                const selectedType = calculationTypeSelect.value;
                const subcategorySelect = document.getElementById('subcategory');
                const selectedSubcategoryKey = subcategorySelect ? subcategorySelect.value : '';

                let currentConfig = null;
                if (selectedType && selectedSubcategoryKey) {
                    const mainCategoryConfig = calculationConfigs[selectedType];
                    const subcategoryConfig = mainCategoryConfig.subcategories[selectedSubcategoryKey];

                    // Check if there are sub-subcategories
                    if (subcategoryConfig && subcategoryConfig.subSubCategories) {
                        const subSubcategorySelect = document.getElementById('subSubcategory');
                        const selectedSubSubcategoryKey = subSubcategorySelect ? subSubcategorySelect.value : '';
                        if (selectedSubSubcategoryKey) {
                            currentConfig = subcategoryConfig.subSubCategories[selectedSubSubcategoryKey];
                        } else {
                            resultText.textContent = 'Por favor, selecione uma Sub-subcategoria.';
                            resultText.style.color = 'red';
                            resultsDiv.classList.remove('hidden');
                            return;
                        }
                    } else {
                        currentConfig = subcategoryConfig;
                    }
                }

                if (!currentConfig) {
                    resultText.textContent = 'Por favor, selecione um Tipo de Cálculo e uma Subcategoria (e sub-subcategoria, se aplicável).';
                    resultText.style.color = 'red';
                    resultsDiv.classList.remove('hidden');
                    return;
                }

                try {
                    const calculationResult = currentConfig.calculo(); // Call the calculo function directly
                    resultText.innerHTML = calculationResult.resultado; // Use innerHTML for rich text
                    resultText.style.color = calculationResult.color || 'green'; // Default to green if no color specified

                    // Display details if available
                    if (calculationResult.detalhes && calculationResult.detalhes.length > 0) {
                        let detailsHtml = '<p class="mt-4 text-gray-600"><strong>Detalhes:</strong></p><ul class="list-disc list-inside">';
                        calculationResult.detalhes.forEach(detail => {
                            detailsHtml += `<li>${detail}</li>`;
                        });
                        detailsHtml += '</ul>';
                        resultText.innerHTML += detailsHtml; // Append details
                    }
                    resultsDiv.classList.remove('hidden');

                } catch (error) {
                    resultText.textContent = `Erro no cálculo: ${error.message}`;
                    resultText.style.color = 'red';
                    resultsDiv.classList.remove('hidden');
                }
            });

            // Popula os tipos de cálculo ao carregar a página
            populateCalculationTypes();
        });
    </script>
</body>
</html>
